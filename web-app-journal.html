<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2020-05-12 Tue 17:48 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Being a Journal of my Java Web-App Development Journey</title>
<meta name="generator" content="Org mode" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=IBM+Plex+Mono:400,400i,600,600i|IBM+Plex+Sans:400,400i,600,600i|IBM+Plex+Serif:400,400i,600,600i">
<link rel="stylesheet" type="text/css" href="org-mode.css" />
<style type="text/css">
/* BODY { background: black; color: white; } */
ol.lower-alpha { list-style-type: lower-alpha; }
.open-question { background: rgba( 255, 0, 255, 0.3); }
</style>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2020 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="org-div-home-and-up">
 <a accesskey="h" href="."> UP </a>
 |
 <a accesskey="H" href="/index.html"> HOME </a>
</div><div id="content">
<h1 class="title">Being a Journal of my Java Web-App Development Journey</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org046ce76">1. Overview</a>
<ul>
<li><a href="#orga716966">1.1. More emo blather about "why Java"</a></li>
<li><a href="#org4444ec4">1.2. A note on horrible colors in source code</a></li>
</ul>
</li>
<li><a href="#orgd431814">2. Java</a>
<ul>
<li><a href="#org51cb2ad">2.1. On a Mac</a></li>
<li><a href="#orgb3fb5fb">2.2. Java EE</a>
<ul>
<li><a href="#jakarta-java-version-question">2.2.1. Question: Does Jakarta EE support any version of Java &gt;= 8?  Answer: apparently not. :(</a></li>
</ul>
</li>
<li><a href="#orged07858">2.3. Editing in emacs</a></li>
</ul>
</li>
<li><a href="#org4228287">3. Tomcat</a>
<ul>
<li><a href="#org6d2d855">3.1. On a Mac</a></li>
<li><a href="#org124cbcb">3.2. On Ubuntu Linux 16.04</a></li>
<li><a href="#orgddf890b">3.3. Deploy code</a></li>
<li><a href="#tomcat-jndi-resources">3.4. <span class="done DONE">DONE</span> JDBC connection and other external configs preserved between version upgrade</a>
<ul>
<li><a href="#orgf534983">3.4.1. <span class="todo TODO">TODO</span> JNDI directory entry vs. injected CDI bean; lifecycle mgmt &amp; JDBC connection pooling</a></li>
<li><a href="#org02067e4">3.4.2. <span class="done DONE">DONE</span> Move <code>Resource</code> from <code>server.xml</code> to <code>context.xml</code></a></li>
<li><a href="#org4a95ef6">3.4.3. Cleanups, now that we got it working</a>
<ul>
<li><a href="#orgba0be2b">3.4.3.1. Put the sqlite driver in <code>${CATALINA_BASE}/lib</code></a></li>
<li><a href="#org3a04c42">3.4.3.2. Note on Context vs. GlobalNamingResources</a></li>
<li><a href="#resource-injection">3.4.3.3. Resource injection</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a href="#org867285f">4. <span class="todo RESEARCH_TODO">RESEARCH-TODO</span> TomEE</a></li>
<li><a href="#org3a02fed">5. Database</a>
<ul>
<li><a href="#orgdbb927e">5.1. Consider an ORM of some sort</a></li>
<li><a href="#org9c66155">5.2. SQLite</a>
<ul>
<li><a href="#org50566d4">5.2.1. Simple command-line use</a></li>
<li><a href="#org7556ccc">5.2.2. How much does it scale?</a></li>
</ul>
</li>
<li><a href="#orgf2ba3c2">5.3. Postgresql</a></li>
<li><a href="#org14afd0b">5.4. Apache Derby</a></li>
</ul>
</li>
<li><a href="#orgf4b4a18">6. JavaEE</a>
<ul>
<li><a href="#org5b5c6a0">6.1. Dependencies</a></li>
<li><a href="#org017dde4">6.2. JavaEE (JakartaEE) specs</a></li>
<li><a href="#orgce570a9">6.3. JavaEE tutorial</a></li>
</ul>
</li>
<li><a href="#orgb022c42">7. JS Framework</a></li>
<li><a href="#orgd0a956d">8. Build system</a>
<ul>
<li><a href="#orgadfb63d">8.1. Gradle</a></li>
<li><a href="#maven">8.2. <span class="done RESEARCH_DONE">RESEARCH-DONE</span> Maven</a>
<ul>
<li><a href="#org3d7d922">8.2.1. Install/update</a></li>
<li><a href="#maven-project-structure">8.2.2. <span class="done RESEARCH_DONE">RESEARCH-DONE</span> Make a project</a>
<ul>
<li><a href="#orgd51de42">8.2.2.1. Effective POM</a></li>
<li><a href="#org9c74a1e">8.2.2.2. Patching up generated POMs</a></li>
<li><a href="#orgd667da9">8.2.2.3. How to define servlets (where the source code goes)</a></li>
<li><a href="#how-to-make-javax-servlet-dependencies-available">8.2.2.4. How to make <code>javax.servlet</code> dependencies available</a></li>
<li><a href="#j2ee-project-structure">8.2.2.5. File structure for "simple J2EE" (ha)</a></li>
<li><a href="#org74e4bdb">8.2.2.6. Further info on the "simple" J2EE packaging, from reference docs</a></li>
</ul>
</li>
<li><a href="#orgdcffa2b">8.2.3. Reactor?  What's that?</a></li>
<li><a href="#orgabaabe6">8.2.4. Useful sites</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#org2463900">9. Version Control</a>
<ul>
<li><a href="#orgaded5d4">9.1. Git mechanics</a>
<ul>
<li><a href="#org73fa9a8">9.1.1. New branch w/current outstanding changes</a></li>
<li><a href="#orgbf4dba4">9.1.2. Merge another branch or commit into the current branch</a></li>
<li><a href="#orgdbaeab1">9.1.3. See the list of commits</a></li>
<li><a href="#org2adcf0e">9.1.4. Restore working dir to match an old version</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#org4c63cb1">10. App code</a>
<ul>
<li><a href="#hello-world">10.1. Simplest possible code</a></li>
<li><a href="#org4dcdea3">10.2. Other aspects to consider</a>
<ul>
<li><a href="#orgf627d26">10.2.1. Packaging &#x2013; how the entire project is structured</a></li>
<li><a href="#servlet-routing">10.2.2. Servlet Routing</a></li>
<li><a href="#org9e260ec">10.2.3. JSON output</a></li>
<li><a href="#org973cb8d">10.2.4. <span class="done DONE">DONE</span> Dependency Injection</a>
<ul>
<li><a href="#org52e8cf9">10.2.4.1. Setup</a>
<ul>
<li><a href="#org9760b88">10.2.4.1.1. <span class="done DONE">DONE</span> Creating injected beans in another module</a>
<ul>
<li><a href="#orge840553">10.2.4.1.1.1. <span class="done RESEARCH_DONE">RESEARCH-DONE</span> Bean scoping</a></li>
<li><a href="#orge34f4b9">10.2.4.1.1.2. <span class="todo HOLD">HOLD</span> <code>beans.xml</code> is optional, supposedly</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#org2a6b7ef">10.2.4.2. Background info</a></li>
</ul>
</li>
<li><a href="#orgc0c9e57">10.2.5. <span class="done DONE">DONE</span> Persistence</a>
<ul>
<li><a href="#org12da0cf">10.2.5.1. <span class="done DONE">DONE</span> SQLite (for now)</a>
<ul>
<li><a href="#org80e85b7">10.2.5.1.1. <span class="done DONE">DONE</span> Create a play sqlite database</a>
<ul>
<li><a href="#org28d0022">10.2.5.1.1.1. <span class="done DONE">DONE</span> Where to put it?</a>
<ul>
<li><a href="#org858826c">10.2.5.1.1.1.1. <span class="done DONE">DONE</span> jar properties</a></li>
<li><a href="#command-line-properties">10.2.5.1.1.1.2. <span class="done DONE">DONE</span> Command-line (or otherwise run-time) properties</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a href="#orgf73bc75">10.2.5.2. <span class="done DONE">DONE</span> Connect to SQLite d/b using JDBC</a>
<ul>
<li><a href="#org597dd4d">10.2.5.2.1. <span class="done DONE">DONE</span> sqlite driver</a></li>
<li><a href="#org0617a1f">10.2.5.2.2. <span class="done DONE">DONE</span> Getting DataSource from JNDI at the right time</a></li>
</ul>
</li>
<li><a href="#org9cf4973">10.2.5.3. <span class="done DONE">DONE</span> Java Persistence API (JPA)</a>
<ul>
<li><a href="#org4c088db">10.2.5.3.1. "Criteria" queries:  Yikes.</a></li>
<li><a href="#orgbcee728">10.2.5.3.2. <span class="done DONE">DONE</span> JPQL</a>
<ul>
<li><a href="#jpql-fetch-plan">10.2.5.3.2.1. <span class="todo TODO">TODO</span> fetch plans</a></li>
<li><a href="#org887824f">10.2.5.3.2.2. <span class="done DONE">DONE</span> EclipseLink</a>
<ul>
<li><a href="#eclipselink-download-and-install">10.2.5.3.2.2.1. <span class="done DONE">DONE</span> Download &amp; install</a></li>
<li><a href="#org3873c50">10.2.5.3.2.2.2. <span class="done DONE">DONE</span> Add EclipseLink to build/deploy</a></li>
<li><a href="#orgf247e98">10.2.5.3.2.2.3. <span class="done DONE">DONE</span> Use EclipseLink in code</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#org36096d5">10.2.5.3.3. <span class="done DONE">DONE</span> Hooking it up</a>
<ul>
<li><a href="#orgdca5fb3">10.2.5.3.3.1. <span class="todo TODO">TODO</span> Transactions</a></li>
<li><a href="#making-weld-process-data-jar">10.2.5.3.3.2. <span class="done DONE">DONE</span> Injection of Persistent Unit via annotations, w/out code (even a <code>@PostConstruct</code> method)</a>
<ul>
<li><a href="#orgc9a4600">10.2.5.3.3.2.1. Do I need to include Weld as a dependecy in any module (e.g., <code>Data</code>) I want to get "cascading" injection in?  (Answer: NO.)</a>
<ul>
<li><a href="#org39777a7">10.2.5.3.3.2.1.1. Old notes from <span class="timestamp-wrapper"><span class="timestamp">&lt;2020-05-09 Sat&gt;</span></span>, mostly ignorable</a></li>
</ul>
</li>
<li><a href="#orgece1867">10.2.5.3.3.2.2. Do I need to explicitly declare the <code>@PersistenceUnit</code> of type <code>EntityManagerFactory</code> an injection point with <code>@Inject</code>? Answer: NO)</a></li>
<li><a href="#orgc6a0425">10.2.5.3.3.2.3. <span class="done DONE">DONE</span> One final possibility: using a CDI producer method to wrap the code snippet</a></li>
</ul>
</li>
<li><a href="#org1c34b71">10.2.5.3.3.3. <span class="done DONE">DONE</span> Preventing resource leaks</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a href="#org0bd882d">10.2.6. <span class="done DONE">DONE</span> Lombok</a></li>
<li><a href="#org7073deb">10.2.7. Logging &amp; Telemetry</a>
<ul>
<li><a href="#org53c7752">10.2.7.1. Responsiveness, measured from the client</a></li>
<li><a href="#orgb5195a5">10.2.7.2. CDI logging</a></li>
<li><a href="#org79eb42e">10.2.7.3. JPA (EclipseLink) logging</a></li>
</ul>
</li>
<li><a href="#org5e8fd92">10.2.8. Security &amp; Griefing</a></li>
<li><a href="#org85810c9">10.2.9. Documentation generation</a></li>
<li><a href="#orgd7cd87b">10.2.10. Automated testing</a>
<ul>
<li><a href="#org2864852">10.2.10.1. Unit</a></li>
<li><a href="#org54a5966">10.2.10.2. Integration</a></li>
<li><a href="#orgf5129d8">10.2.10.3. Database?</a></li>
</ul>
</li>
<li><a href="#org8acba66">10.2.11. Code coverage during [automated] testing</a></li>
<li><a href="#org64206f4">10.2.12. Command pattern, undo/redo trees</a></li>
<li><a href="#org8fa05f0">10.2.13. Well-known APIs</a>
<ul>
<li><a href="#org7498ad9">10.2.13.1. Documenting with something like Swagger</a></li>
</ul>
</li>
<li><a href="#org52eaab2">10.2.14. Data export/import</a></li>
<li><a href="#org32216e4">10.2.15. Stress testing, esp. for database</a></li>
<li><a href="#org66050b9">10.2.16. SQL profiling, tracing</a></li>
<li><a href="#org0576a03">10.2.17. <span class="todo IN_PROGRESS">IN-PROGRESS</span> Object mappers (Domain/DTO)</a>
<ul>
<li><a href="#orgad92545">10.2.17.1. <span class="todo HOLD">HOLD</span> JMapper</a></li>
<li><a href="#orgd69b8bb">10.2.17.2. <span class="todo IN_PROGRESS">IN-PROGRESS</span> Mapstruct</a>
<ul>
<li><a href="#org4c7f15f">10.2.17.2.1. <span class="todo RESEARCH_TODO">RESEARCH-TODO</span> Using Builders</a></li>
</ul>
</li>
<li><a href="#org1811eac">10.2.17.3. <span class="done DONE">DONE</span> Is this required when using JPQL?</a></li>
<li><a href="#org160598f">10.2.17.4. <span class="done DONE">DONE</span> Is this required when using Criteria?</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a href="#org8bebbb9">11. Operations</a>
<ul>
<li><a href="#org65963e8">11.1. Deploying</a>
<ul>
<li><a href="#org95667f5">11.1.1. Deploying as part of build (via Maven)</a></li>
</ul>
</li>
<li><a href="#orgd88863c">11.2. Diagnosing Deploy-Time Errors</a>
<ul>
<li><a href="#org0fe80c1">11.2.1. Injection failures</a>
<ul>
<li><a href="#org384a36d">11.2.1.1. <span class="done DONE">DONE</span> Unsatisfied dependencies</a>
<ul>
<li><a href="#org78cab2a">11.2.1.1.1. Further notes on dependencies and required build (POM) structuring</a></li>
</ul>
</li>
<li><a href="#org0db2a7d">11.2.1.2. <span class="done DONE">DONE</span> Ambiguous dependencies</a>
<ul>
<li><a href="#org14623bb">11.2.1.2.1. On annotations</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#orgf15a637">11.2.2. <span class="done DONE">DONE</span> D/B connection problems (JNDI problem)</a>
<ul>
<li><a href="#org653f7eb">11.2.2.1. <span class="done DONE">DONE</span> Direct JDBC connection</a></li>
<li><a href="#web-xml-structure">11.2.2.2. <span class="done RESEARCH_DONE">RESEARCH-DONE</span> <code>web.xml</code> structure</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#orgb45a659">11.3. <span class="done DONE">DONE</span> Debugging</a></li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-org046ce76" class="outline-2">
<h2 id="org046ce76"><span class="section-number-2">1</span> Overview</h2>
<div class="outline-text-2" id="text-1">
<p>
I'm going to keep a diary of my effort to develop a web app from soup to nuts.  This is an emacs
org-mode file that's part "living document" and part journal.  I skip around a bit in writing it
because <i>this part</i> goes with <i>that part</i>, but it's also a bit chronological as you get into
various sections and I'm problem-solving.
</p>

<p>
A very long time ago (15 years??), I was a semi-competent Java web-app programmer, and I'd like to
get back to that.  I've spent enough time in the Microsoft world, which has a different
character<sup><a id="fnr.1" class="footref" href="#fn.1">1</a></sup>, and I miss the Java world.
</p>

<p>
My background is Java from the 90s (yes, it's that old) and early 2000s.  I worked for a startup
that made a web app in the days before "Web 2.0", and we were poor and crude.  (We did survive the
dot-com crash in some form, though.)  No JS framework (apart from the absolutely horrible one we
came up with on our own &#x2013; don't do that).  No persistence layer apart from direct JDBC calls
(even though TopLink was available, as were others such as Cayenne and Hibernate).  We used Apache
and Tomcat and JBoss on Windows NT.  No Spring.  No Nginx.  No Jetty.  (I still don't know Spring;
I might make it part of this project later.)  Lots of Unix experience (Perl, bash, awk, make, and
friends) from before that.
</p>

<p>
The initial plans for this project are in <a href="README.html">README.org</a>.  (At
<a href="https://github.com/JohnL4/LayLeadership">https://github.com/JohnL4/LayLeadership</a>.)
</p>
</div>

<div id="outline-container-orga716966" class="outline-3">
<h3 id="orga716966"><span class="section-number-3">1.1</span> More emo blather about "why Java"</h3>
<div class="outline-text-3" id="text-1-1">
<p>
(You can skip this; it's information-free.)
</p>

<p>
Some people will ask "Why Java?  Why not Node or Ruby [do people still say that?] or Kotlin or Go
or serverless or C# [seriously?<sup><a id="fnr.3" class="footref" href="#fn.3">3</a></sup>] or Blazor or <i>&lt;superior framework I haven't heard of
yet&gt;</i>?  Java EE is <i>h-a-a-a-a-r-r-r-d</i> [Barbie voice]."
</p>

<p>
Because:
</p>

<ul class="org-ul">
<li>My roots.</li>
<li>Performance:  Java is pretty zippy.</li>
<li>Strong, static typing for the win.</li>
<li>Universality.  COBOL of the 90s, if you know what I mean.</li>
<li>Really good enterprise structuring.  When my little side project grows up to be the 800-lb
gorilla of church software, I'll be glad its foundations are solid.</li>
<li>Less magic, if you stay away from all the stuff "smart" IDEs (like Eclipse) can do for/to you.
<i>Some</i> languages are pretty tightly bound to their IDEs.  You know who I'm talking about.
[squinty eyes]</li>
<li>Related to the "enterprise" point:  I really want the skill of being able to whip out,
<i>quickly</i>, a well-structured web-app solution for whatever situation.  For example, one of the
things I've seen recently with various social-activism groups is a call for "web development".
Wouldn't it be spiffy to pretty much immediately plunk down a complete, well-formed solution?</li>
</ul>
</div>
</div>

<div id="outline-container-org4444ec4" class="outline-3">
<h3 id="org4444ec4"><span class="section-number-3">1.2</span> A note on horrible colors in source code</h3>
<div class="outline-text-3" id="text-1-2">
<p>
Sometimes, I generate this file running emacs in character mode via an <code>ssh</code> terminal session.
In that case, I use colors appropriate to "dark mode" and they come out looking horrible.  Sorry
about that.  Hopefully, you're reading this after I've generated it via light-mode GUI and emacs
is using different colors.
</p>
</div>
</div>
</div>

<div id="outline-container-orgd431814" class="outline-2">
<h2 id="orgd431814"><span class="section-number-2">2</span> Java</h2>
<div class="outline-text-2" id="text-2">
<p>
Currently running my wiki on JSPWiki on Tomcat 8 on Java 8.  I'd like to run a different process
on Java whatever-is-the-latest.  (Note: see <a href="#jakarta-java-version-question">the Jakarta/Java version question</a>.)
</p>

<p>
Looks like some process has kept Java up to date on my AWS server.  Yay.  Also, apparently,
openjdk is legal to use.  Yay.
</p>

<p>
<a href="https://adoptopenjdk.net/index.html">https://adoptopenjdk.net/index.html</a> has the builds for download.
</p>

<p>
<a href="https://docs.oracle.com/en/java/javase/11/">https://docs.oracle.com/en/java/javase/11/</a> has tool documentation (<code>javac</code>, <code>java</code>, etc.).  I
haven't yet found these docs in any downloaded packages.
</p>
</div>

<div id="outline-container-org51cb2ad" class="outline-3">
<h3 id="org51cb2ad"><span class="section-number-3">2.1</span> On a Mac</h3>
<div class="outline-text-3" id="text-2-1">
<p>
On a Mac, the OpenJDK 8 installer puts files in
<code>/Library/Java/JavaVirtualMachines/adoptopenjdk-8.jdk/Contents/Home/bin</code>, but I can't seem to
symlink them in to <code>/usr/bin</code>.
</p>
</div>
</div>

<div id="outline-container-orgb3fb5fb" class="outline-3">
<h3 id="orgb3fb5fb"><span class="section-number-3">2.2</span> Java EE</h3>
<div class="outline-text-3" id="text-2-2">
<p>
Well, first off, a <i>lot</i> has happened in the Java world since I left it, around 2005 or so.
(Pshew, was it really that long ago?  Oy.)
</p>

<p>
Java EE has become Jakarta EE, and is now managed by the Eclipse Foundation.  It appears that, as
of <span class="timestamp-wrapper"><span class="timestamp">&lt;2020-03-09 Mon&gt;</span></span>, Java EE 8 is the download (from Oracle), but, in future, I guess we'll be
getting new versions from <a href="https://jakarta.ee/">https://jakarta.ee/</a>.
</p>
</div>

<div id="outline-container-org9cb3cc8" class="outline-4">
<h4 id="jakarta-java-version-question"><span class="section-number-4">2.2.1</span> Question: Does Jakarta EE support any version of Java &gt;= 8?  Answer: apparently not. :(</h4>
<div class="outline-text-4" id="text-jakarta-java-version-question">
<p>
Based on this quote: <i>"We also have to move the APIs to support JDK 11."</i> from this article:
<a href="https://dzone.com/articles/jakarta-ee-8-and-beyond">https://dzone.com/articles/jakarta-ee-8-and-beyond</a>.
</p>

<p>
(Note: the jars probably still run just fine on higher versions of Java, I guess they just don't
take advantage of the latest features of the language.  I kinda don't care, so long as they run
properly.) 
</p>
</div>
</div>
</div>

<div id="outline-container-orged07858" class="outline-3">
<h3 id="orged07858"><span class="section-number-3">2.3</span> Editing in emacs</h3>
<div class="outline-text-3" id="text-2-3">
<p>
This might be a lost cause, but if you want to get away from magic tools like IntelliJ, Eclipse,
VS Code, &#x2026;
</p>

<p>
<a href="https://www.emacswiki.org/emacs/JavaDevelopmentEnvironment">https://www.emacswiki.org/emacs/JavaDevelopmentEnvironment</a>
</p>

<p>
<a href="https://blog.jmibanez.com/2019/03/31/emacs-as-java-ide-revisited.html">https://blog.jmibanez.com/2019/03/31/emacs-as-java-ide-revisited.html</a>
</p>
</div>
</div>
</div>

<div id="outline-container-org4228287" class="outline-2">
<h2 id="org4228287"><span class="section-number-2">3</span> Tomcat</h2>
<div class="outline-text-2" id="text-3">
</div>
<div id="outline-container-org6d2d855" class="outline-3">
<h3 id="org6d2d855"><span class="section-number-3">3.1</span> On a Mac</h3>
<div class="outline-text-3" id="text-3-1">
<p>
Unzipped Tomcat 9 to <code>/opt</code>.
</p>

<p>
Created user <code>tomcat</code> using Mac "Users and Groups" control panel applet.  Disabled login by
<code>tomcat</code> with the following shell command:
</p>

<pre class="example">
sudo chpass -s /usr/bin/false tomcat
</pre>


<p>
chown'd the resulting directory (recursively) to user <code>tomcat</code>.
</p>

<p>
Created a simple <code>start-tomcat</code> (and analogous <code>stop-tomcat</code>) script in
<code>/opt/apache-tomcat-9.0.31/bin</code> directory:
</p>

<div class="org-src-container">
<pre class="src src-shell"><span style="color: #36648b; font-style: italic;">#</span><span style="color: #36648b; font-style: italic;">!/bin/</span><span style="color: #a020f0;">bash</span>

<span style="color: #483d8b;">export</span> <span style="color: #8b6914;">CATALINA_HOME</span>=/opt/apache-tomcat-9.0.31

<span style="color: #36648b; font-style: italic;"># </span><span style="color: #36648b; font-style: italic;">export CATALINA_BASE=~/Tomcat/apache-tomcat-9.0</span>

<span style="color: #483d8b;">export</span> <span style="color: #8b6914;">JAVA_HOME</span>=/Library/Java/JavaVirtualMachines/adoptopenjdk-8.jdk/Contents/Home

<span style="color: #a020f0;">exec</span> su -m tomcat ${<span style="color: #8b6914;">CATALINA_HOME</span>}/bin/catalina.sh start
</pre>
</div>

<p>
Edited <code>/opt/apache-tomcat-9.0.31/conf/tomcat-users.xml</code> to add users for manager-gui, admin-gui
and (separate user) manager-script, admin-script.
</p>

<p>
Running on AdoptOpenJDK 11 is as easy as downloading and installing it and changing the above
<code>JAVA_HOME</code> to point to the new JDK.  It seems to run without problem.
</p>

<p>
It should also be possible to install it via homebrew, which might then keep it up to date better than a manual
install process would.
</p>

<p>
For homebrew, you'll need to open a "tap" (i.e., add another repository), and then install the "cask" for the jdk you
want.  See the instructions at the adoptopenjdk.
</p>
</div>
</div>

<div id="outline-container-org124cbcb" class="outline-3">
<h3 id="org124cbcb"><span class="section-number-3">3.2</span> On Ubuntu Linux 16.04</h3>
<div class="outline-text-3" id="text-3-2">
<p>
See <a href="http://tarheel-nc.s3-website-us-east-1.amazonaws.com/tomcat-9-setup.html">http://tarheel-nc.s3-website-us-east-1.amazonaws.com/tomcat-9-setup.html</a>.
</p>
</div>
</div>

<div id="outline-container-orgddf890b" class="outline-3">
<h3 id="orgddf890b"><span class="section-number-3">3.3</span> Deploy code</h3>
<div class="outline-text-3" id="text-3-3">
<p>
Well, first you have to write some code.  See <a href="#hello-world">Simplest possible code</a>.
</p>
</div>
</div>

<div id="outline-container-org195974b" class="outline-3">
<h3 id="tomcat-jndi-resources"><span class="section-number-3">3.4</span> <span class="done DONE">DONE</span> JDBC connection and other external configs preserved between version upgrade</h3>
<div class="outline-text-3" id="text-tomcat-jndi-resources">
<p>
See
</p>

<ul class="org-ul">
<li><del><a href="https://serverfault.com/a/751477">https://serverfault.com/a/751477</a></del> <b>Note:</b> the advice to put the config in <code>server.xml</code> is
basically wrong.  Instead, follow the instructions at
<a href="https://tomcat.apache.org/tomcat-9.0-doc/jndi-resources-howto.html#JDBC_Data_Sources">https://tomcat.apache.org/tomcat-9.0-doc/jndi-resources-howto.html#JDBC_Data_Sources</a>, and put
it in <code>context.xml</code>.</li>
<li><a href="https://newfivefour.com/category_sqlite.html">https://newfivefour.com/category_sqlite.html</a></li>
</ul>

<p>
From <code>/opt/apache-tomcat-9.0.31/conf/server.xml</code>:
</p>

<pre class="example">
&lt;!-- Global JNDI resources
     Documentation at /docs/jndi-resources-howto.html
--&gt;
</pre>

<p>
&#x2026;which is <a href="https://tomcat.apache.org/tomcat-9.0-doc/jndi-resources-howto.html">https://tomcat.apache.org/tomcat-9.0-doc/jndi-resources-howto.html</a>
</p>

<p>
(<a href="https://tomcat.apache.org/tomcat-9.0-doc/jndi-datasource-examples-howto.html">https://tomcat.apache.org/tomcat-9.0-doc/jndi-datasource-examples-howto.html</a> might also be interesting.)
</p>

<p>
So, rather than learn all of JNDI, I think all you need to know is that it's essentially a
directory of resources available for lookup by code in your app.  Said directory can be served by
a local server (e.g., your Tomcat instance creating an ersatz read-only version out of whole
cloth) or it could be served by another server and magically looked up.  Said other server could
be a JNDI server, an LDAP server or a Microsoft Active Directory server; we sort of don't care
because it should be transparent to our code.  More or less.
</p>

<p>
We're doing the ersatz-out-of-whole-cloth version here.
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">SQLite <code>driverClassName</code></td>
<td class="org-left"><code>org.sqlite.JDBC</code> (at least, that's what we'll try)</td>
</tr>

<tr>
<td class="org-left">SQLite connection url</td>
<td class="org-left"><code>jdbc:sqlite:/usr/local/var/LayLeadership/tasks.db</code></td>
</tr>
</tbody>
</table>

<p>
So, we'll try this, in <code>/opt/apache-tomcat-9.0.31/conf/server.xml</code>:
</p>

<div class="org-src-container">
<pre class="src src-xml">&lt;<span style="color: #0000ff;">GlobalNamingResources</span>&gt;
  <span style="color: #36648b; font-style: italic;">&lt;!-- ...stuff... --&gt;</span>
  &lt;<span style="color: #0000ff;">Resource</span> <span style="color: #8b6914;">name</span>=<span style="color: #b22222;">"jdbc/LayLeadershipTasks"</span>
            <span style="color: #8b6914;">auth</span>=<span style="color: #b22222;">"Container"</span>
            <span style="color: #8b6914;">type</span>=<span style="color: #b22222;">"javax.sql.DataSource"</span>
            <span style="color: #8b6914;">driverClassName</span>=<span style="color: #b22222;">"org.sqlite.JDBC"</span>
            <span style="color: #8b6914;">url</span>=<span style="color: #b22222;">"jdbc:sqlite:/usr/local/var/LayLeadership/tasks.db"</span>
            /&gt;
  <span style="color: #36648b; font-style: italic;">&lt;!-- ...stuff... --&gt;</span>
&lt;/<span style="color: #0000ff;">GlobalNamingResources</span>&gt;
</pre>
</div>

<p>
This will probably require deploying the SQLite jar(s) to the server's libs, since this
definition is at the server global level.
</p>

<p>
This is how I did that:
</p>

<pre class="example">
deimos# pwd
/opt/apache-tomcat-9.0.31/lib

deimos# cp ~/.m2/repository/org/xerial/sqlite-jdbc/3.30.1/sqlite-jdbc-3.30.1.jar .
</pre>

<p>
(So I deployed exactly what I'm building with.)
</p>
</div>

<div id="outline-container-orgf534983" class="outline-4">
<h4 id="orgf534983"><span class="section-number-4">3.4.1</span> <span class="todo TODO">TODO</span> JNDI directory entry vs. injected CDI bean; lifecycle mgmt &amp; JDBC connection pooling</h4>
<div class="outline-text-4" id="text-3-4-1">
<p>
Note that, when the dust has settled, this is not a CDI bean we're injecting somewhere, but it is a JNDI directory
entry that we'll look up to get a <code>DataSource</code>, at some point (possibly during CDI injection of a bean; TODO: CDI
bean lifecycle, because we'll need to return the JDBC connection to the pool when the bean is shut down).  That
might be obvious, but I was a little confused about it for a bit.
</p>

<p>
Injected bean lifecycle events: <code>@PostConstruct</code>, <code>@PreDestroy</code>.
</p>
</div>
</div>

<div id="outline-container-org02067e4" class="outline-4">
<h4 id="org02067e4"><span class="section-number-4">3.4.2</span> <span class="done DONE">DONE</span> Move <code>Resource</code> from <code>server.xml</code> to <code>context.xml</code></h4>
<div class="outline-text-4" id="text-3-4-2">
<p>
It turns out (for whatever reason), putting this in <code>server.xml</code> <code>GlobalNamingResources</code> is not
the answer.  Instead, it should go into <code>META-INF/context.xml</code>, in a <code>Context</code> element, per
<a href="https://tomcat.apache.org/tomcat-9.0-doc/jndi-resources-howto.html#JDBC_Data_Sources">https://tomcat.apache.org/tomcat-9.0-doc/jndi-resources-howto.html#JDBC_Data_Sources</a>. 
</p>
</div>
</div>

<div id="outline-container-org4a95ef6" class="outline-4">
<h4 id="org4a95ef6"><span class="section-number-4">3.4.3</span> Cleanups, now that we got it working</h4>
<div class="outline-text-4" id="text-3-4-3">
<p>
After moving the JNDI entry definition to <code>context.xml</code>, we got it working, but with code like
the following in our SQL repository:
</p>

<div class="org-src-container">
<pre class="src src-java"><span style="color: #36648b; font-style: italic;">// </span><span style="color: #36648b; font-style: italic;">Guessing it's ok to hold on to the DataSource for a long time.</span>
<span style="color: #228b22;">var</span> <span style="color: #8b6914;">initialContext</span> = <span style="color: #a020f0;">new</span> <span style="color: #228b22;">InitialContext</span>(  );
_dataSource = (<span style="color: #228b22;">DataSource</span>) initialContext.lookup( <span style="color: #b22222;">"java:comp/env/"</span> + DATABASE_JNDI_NAME);
</pre>
</div>

<p>
So, (a) it'd be nice if we could inject the DataSource rather than create it ourselves, and (b)
there are possible glitches called out in
<a href="https://tomcat.apache.org/tomcat-9.0-doc/jndi-datasource-examples-howto.html">https://tomcat.apache.org/tomcat-9.0-doc/jndi-datasource-examples-howto.html</a>.
</p>
</div>

<div id="outline-container-orgba0be2b" class="outline-5">
<h5 id="orgba0be2b"><span class="section-number-5">3.4.3.1</span> Put the sqlite driver in <code>${CATALINA_BASE}/lib</code></h5>
<div class="outline-text-5" id="text-3-4-3-1">
<p>
Basically, at the top/system level for the entire Tomcat web server.
</p>
</div>
</div>

<div id="outline-container-org3a04c42" class="outline-5">
<h5 id="org3a04c42"><span class="section-number-5">3.4.3.2</span> Note on Context vs. GlobalNamingResources</h5>
<div class="outline-text-5" id="text-3-4-3-2">
<p>
tl;dr: It should have worked.
</p>

<p>
<a href="https://tomcat.apache.org/tomcat-9.0-doc/jndi-datasource-examples-howto.html#Context_versus_GlobalNamingResources">https://tomcat.apache.org/tomcat-9.0-doc/jndi-datasource-examples-howto.html#Context_versus_GlobalNamingResources</a>
</p>
</div>
</div>

<div id="outline-container-orgf2f5094" class="outline-5">
<h5 id="resource-injection"><span class="section-number-5">3.4.3.3</span> Resource injection</h5>
<div class="outline-text-5" id="text-resource-injection">
<div class="org-src-container">
<pre class="src src-java"><span style="color: #008b8b;">@ApplicationScoped</span>
<span style="color: #a020f0;">public</span> <span style="color: #a020f0;">class</span> <span style="color: #228b22;">LayLeadershipSqliteRepository</span> <span style="color: #a020f0;">implements</span> <span style="color: #228b22;">LayLeadershipRepository</span>
{
   <span style="color: #a020f0;">private</span> <span style="color: #a020f0;">static</span> <span style="color: #a020f0;">final</span> <span style="color: #228b22;">String</span> <span style="color: #8b6914;">DATABASE_JNDI_NAME</span> = <span style="color: #b22222;">"jdbc/LayLeadership"</span>;
   <span style="color: #008b8b;">@Resource</span>( name = DATABASE_JNDI_NAME) <span style="color: #36648b; font-style: italic;">// </span><span style="color: #36648b; font-style: italic;">Automatically prefixes "java:comp/env" onto this resource.  SUPPOSEDLY, you can use 'lookup =' to give a complete path.</span>
   <span style="color: #a020f0;">private</span> <span style="color: #228b22;">DataSource</span> <span style="color: #8b6914;">_dataSource</span>;
</pre>
</div>

<p>
There are a couple of things going on here (I think):
</p>

<ol class="org-ol">
<li><p>
We put <code>@ApplicationScoped</code> on the bean to make sure the container knows it's a managed bean
("managed" by CDI).  I don't think the exact scope matters, so long as there's a CDI scope
attribute so the container knows it's managed.  We do this because resource injection only
happens on managed objects.
</p>

<p>
(Note that we might need to do this anyway if we're going to move the "Repository" interface
back to another Maven module, like the <code>Svc</code> module.)
</p></li>

<li><p>
We put a <code>@Resource</code> attribute on the thing we want injected from the JNDI directory.  Since
we used the <code>name</code> argument, we automatically get shunted off to <code>java:comp/env</code>.
</p>

<p>
Internet rumor has it that you can use <code>resource</code> to specify an entirely different path in
the JNDI directory.
</p>

<p>
I noticed (by accident) that if you get the name of the resource wrong, you get a big, nasty
error in the web app itself (like&#x2026; a faceful of stack trace), which is good.  At least you
know the lookup is being attempted.  If you put in an intentionally wrong resource name and
get no errors, you know the lookup isn't being attempted at all.  For what that's worth.
</p></li>
</ol>
</div>
</div>
</div>
</div>
</div>

<div id="outline-container-org867285f" class="outline-2">
<h2 id="org867285f"><span class="section-number-2">4</span> <span class="todo RESEARCH_TODO">RESEARCH-TODO</span> TomEE</h2>
<div class="outline-text-2" id="text-4">
<p>
Variant of Tomcat that has more JavaEE libraries.  It may be possible to deploy it as a webapp, somehow.  Offers
container-managed JPA, among many other things.  TODO: research feasibility.
</p>
</div>
</div>

<div id="outline-container-org3a02fed" class="outline-2">
<h2 id="org3a02fed"><span class="section-number-2">5</span> Database</h2>
<div class="outline-text-2" id="text-5">
</div>
<div id="outline-container-orgdbb927e" class="outline-3">
<h3 id="orgdbb927e"><span class="section-number-3">5.1</span> Consider an ORM of some sort</h3>
<div class="outline-text-3" id="text-5-1">
<p>
This might require using a "more real" database than Sqlite.  Although it might be fun to try. :)
</p>

<p>
<a href="https://www.eversql.com/i-followed-hibernate-orm-to-hell-and-came-back-alive-to-tell-about-it/">https://www.eversql.com/i-followed-hibernate-orm-to-hell-and-came-back-alive-to-tell-about-it/</a>
</p>

<p>
<a href="https://hackr.io/blog/java-frameworks">https://hackr.io/blog/java-frameworks</a> &#x2013; Hibernate's in here, along with a <i>ton</i> of other
frameworks.  Sounds like a good page to refer back to.
</p>

<p>
EclipseLink is the reference implementation for JPA.
</p>
</div>
</div>

<div id="outline-container-org9c66155" class="outline-3">
<h3 id="org9c66155"><span class="section-number-3">5.2</span> SQLite</h3>
<div class="outline-text-3" id="text-5-2">
<p>
See
</p>
<ul class="org-ul">
<li><a href="https://newfivefour.com/category_sqlite.html">https://newfivefour.com/category_sqlite.html</a></li>
</ul>
</div>

<div id="outline-container-org50566d4" class="outline-4">
<h4 id="org50566d4"><span class="section-number-4">5.2.1</span> Simple command-line use</h4>
<div class="outline-text-4" id="text-5-2-1">
<div class="org-src-container">
<pre class="src src-bash">sqlite3 &lt;database-file&gt;
</pre>
</div>

<p>
(Database files will probably have a suffix like <code>.sqlite</code> or <code>.db</code>.)
</p>

<div class="org-src-container">
<pre class="src src-sql">.mode columns                   <span style="color: #36648b; font-style: italic;">-- Normal format is "|"-delimited, which is great for awk</span>
.headers <span style="color: #a020f0;">on</span>                     <span style="color: #36648b; font-style: italic;">-- Column headers</span>
<span style="color: #a020f0;">select</span> * <span style="color: #a020f0;">from</span> Member;           <span style="color: #36648b; font-style: italic;">-- Don't forget the semicolon</span>
.quit
</pre>
</div>
</div>
</div>

<div id="outline-container-org7556ccc" class="outline-4">
<h4 id="org7556ccc"><span class="section-number-4">5.2.2</span> How much does it scale?</h4>
<div class="outline-text-4" id="text-5-2-2">
<p>
For a toy app (on a toy server), I don't need much.
</p>

<p>
But&#x2026; it looks like it scales quite well, actually.
</p>

<p>
<a href="https://blog.expensify.com/2018/01/08/scaling-sqlite-to-4m-qps-on-a-single-server/">https://blog.expensify.com/2018/01/08/scaling-sqlite-to-4m-qps-on-a-single-server/</a>
</p>

<p>
<a href="https://stackoverflow.com/a/62220">https://stackoverflow.com/a/62220</a>
</p>

<p>
<a href="https://news.ycombinator.com/item?id=11934826">https://news.ycombinator.com/item?id=11934826</a>
</p>

<p>
<a href="https://www.whoishostingthis.com/compare/sqlite/optimize/">https://www.whoishostingthis.com/compare/sqlite/optimize/</a>
</p>
</div>
</div>
</div>

<div id="outline-container-orgf2ba3c2" class="outline-3">
<h3 id="orgf2ba3c2"><span class="section-number-3">5.3</span> Postgresql</h3>
<div class="outline-text-3" id="text-5-3">
<p>
Well, after all the Sqlite awesomeness, maybe I'll put this bad boy off a while more.  I don't
really intend to become a d/b geek.
</p>
</div>
</div>

<div id="outline-container-org14afd0b" class="outline-3">
<h3 id="org14afd0b"><span class="section-number-3">5.4</span> Apache Derby</h3>
<div class="outline-text-3" id="text-5-4">
<p>
Pure Java embedded database, but probably not as widely used as Sqlite.  Advantage: probably
works well with Hibernate and other Java technologies.  Derby seems to perform better.
</p>

<p>
As if I care, with my 12-record database.
</p>
</div>
</div>
</div>

<div id="outline-container-orgf4b4a18" class="outline-2">
<h2 id="orgf4b4a18"><span class="section-number-2">6</span> JavaEE</h2>
<div class="outline-text-2" id="text-6">
<p>
I feel like there's a license restriction on the EE libs from Oracle.  So I need to find an
implementation I can use.
</p>

<p>
Turns out&#x2026;
</p>

<blockquote>
<p>
The Apache Tomcat® software is an open source implementation of the Java Servlet, JavaServer
Pages, Java Expression Language and Java WebSocket technologies. The Java Servlet, JavaServer
Pages, Java Expression Language and Java WebSocket specifications are developed under the Java
Community Process.
</p>
</blockquote>

<p>
(From <a href="https://tomcat.apache.org/">https://tomcat.apache.org/</a>, right at the top.)
</p>

<p>
This at least satisfies the compiler:
</p>

<pre class="example">
javac -cp /opt/apache-tomcat-9.0.31/lib/servlet-api.jar com/how_hard_can_it_be/play/Main.java
</pre>


<p>
Where the code looks like this:
</p>

<div class="org-src-container">
<pre class="src src-java"><span style="color: #a020f0;">package</span> com.how_hard_can_it_be.<span style="color: #008b8b;">play</span>;

<span style="color: #a020f0;">import</span> <span style="color: #008b8b;">java</span>.<span style="color: #008b8b;">nio</span>.<span style="color: #008b8b;">file</span>.<span style="color: #228b22;">Paths</span>;
<span style="color: #a020f0;">import</span> <span style="color: #008b8b;">javax</span>.<span style="color: #008b8b;">servlet</span>.<span style="color: #008b8b;">http</span>.<span style="color: #228b22;">HttpServlet</span>;

<span style="color: #a020f0;">public</span> <span style="color: #a020f0;">class</span> <span style="color: #228b22;">Main</span>
{
   <span style="color: #a020f0;">public</span> <span style="color: #a020f0;">static</span> <span style="color: #228b22;">void</span> <span style="color: #0000ff;">main</span>( <span style="color: #228b22;">String</span>[] <span style="color: #8b6914;">args</span>)
   {
      System.out.println( <span style="color: #b22222;">"Hello!"</span>);

      <span style="color: #228b22;">var</span> <span style="color: #8b6914;">path</span> = Paths.get(<span style="color: #b22222;">"./test-data.txt"</span>);

      System.out.println(  String.format( <span style="color: #b22222;">"Path: %s"</span>, path.normalize().toAbsolutePath()));
   }

   <span style="color: #a020f0;">private</span> <span style="color: #228b22;">void</span> <span style="color: #0000ff;">handleServlet</span>( <span style="color: #228b22;">HttpServlet</span> <span style="color: #8b6914;">aServlet</span>)
   {

   }
}
</pre>
</div>
</div>

<div id="outline-container-org5b5c6a0" class="outline-3">
<h3 id="org5b5c6a0"><span class="section-number-3">6.1</span> Dependencies</h3>
<div class="outline-text-3" id="text-6-1">
<p>
<i>I think</i> you can also add them via Maven (from
<a href="https://mvnrepository.com/artifact/javax.servlet/javax.servlet-api/4.0.1">https://mvnrepository.com/artifact/javax.servlet/javax.servlet-api/4.0.1</a>):
</p>

<p>
See <a href="#how-to-make-javax-servlet-dependencies-available">How to make <code>javax.servlet</code> dependencies available</a>, below.
</p>
</div>
</div>

<div id="outline-container-org017dde4" class="outline-3">
<h3 id="org017dde4"><span class="section-number-3">6.2</span> JavaEE (JakartaEE) specs</h3>
<div class="outline-text-3" id="text-6-2">
<p>
JavaEE is a big umbrella.  Here's a table listing all the subparts and versions:
</p>

<p>
<a href="https://javaee.github.io/javaee-spec/Specifications">https://javaee.github.io/javaee-spec/Specifications</a>
</p>

<p>
or
</p>

<p>
<a href="https://jakarta.ee/">https://jakarta.ee/</a>
</p>
</div>
</div>

<div id="outline-container-orgce570a9" class="outline-3">
<h3 id="orgce570a9"><span class="section-number-3">6.3</span> JavaEE tutorial</h3>
<div class="outline-text-3" id="text-6-3">
<p>
Version 8: <a href="https://javaee.github.io/tutorial/">https://javaee.github.io/tutorial/</a>
</p>

<p>
This thing is monstrous.  Also, this "tutorial" isn't very gentle; it's more like a reference (I
like that).
</p>
</div>
</div>
</div>

<div id="outline-container-orgb022c42" class="outline-2">
<h2 id="orgb022c42"><span class="section-number-2">7</span> JS Framework</h2>
</div>

<div id="outline-container-orgd0a956d" class="outline-2">
<h2 id="orgd0a956d"><span class="section-number-2">8</span> Build system</h2>
<div class="outline-text-2" id="text-8">
</div>
<div id="outline-container-orgadfb63d" class="outline-3">
<h3 id="orgadfb63d"><span class="section-number-3">8.1</span> Gradle</h3>
<div class="outline-text-3" id="text-8-1">
<p>
Gradle is not the clean, well-documented system I had hoped for.  Maybe if this turns into a big,
giant project, it might pay off, but there seems to be a ton of black magic documented in example
code and (probably) StackOverflow answers, so&#x2026; maybe just use Maven.
</p>
</div>
</div>

<div id="outline-container-org58a0203" class="outline-3">
<h3 id="maven"><span class="section-number-3">8.2</span> <span class="done RESEARCH_DONE">RESEARCH-DONE</span> Maven</h3>
<div class="outline-text-3" id="text-maven">
<p>
Back to Maven, until I give up on it again.
</p>

<p>
Need to figure out how to download dependencies over https.
</p>

<p>
Answer: switch the urls to be "https" instead of "http".  Also, purge your local <code>.m2</code> repository
and let it get repopulated.  Before I figured this out, I wrote a bunch of notes on "oddities" of
Maven.  Turns out I had an ancient <code>.m2</code> repository with a bunch of old Maven poms (or whatever)
in it from older Java days and before the transition to HTTPS (from HTTP) for Maven Central, and
so and so forth.  Taking off and nuking the <code>.m2</code> repository from orbit turned out to be the
solution.  (Hopefully, my old/ancient projects will still build, but&#x2026; eh.  Problem for another
day.)
</p>

<p>
Need to figure out a project structure.  Somewhere between simple-weapp and J2EE-webapp.
</p>
</div>

<div id="outline-container-org3d7d922" class="outline-4">
<h4 id="org3d7d922"><span class="section-number-4">8.2.1</span> Install/update</h4>
<div class="outline-text-4" id="text-8-2-1">
<p>
Update maven, configure PATH.  (Is that really all I have to do?)  On a Mac.
</p>

<p>
Ok, so, I just downloaded the zip from Apache, unzipped it into <code>/opt</code> and symlinked the <i>three</i>
executable files in the <code>bin</code> directory to <code>/usr/local/bin</code>, which is already on the path.
</p>
</div>
</div>

<div id="outline-container-org29253ef" class="outline-4">
<h4 id="maven-project-structure"><span class="section-number-4">8.2.2</span> <span class="done RESEARCH_DONE">RESEARCH-DONE</span> Make a project</h4>
<div class="outline-text-4" id="text-maven-project-structure">
<p>
After much reading of Maven docs (finally), I think something like the J2EE project structure
(below, but you probably don't need to go read it) is the way to go.  All I ever built in the
past was a single Maven project, but a project (parent or aggregate, packaging = <code>pom</code>) that has
the following sub-projects shouldn't be too hard.
</p>

<ul class="org-ul">
<li><a id="org923d847"></a> business logic, with minimal dependencies (onion architecture core,
(<a href="https://jeffreypalermo.com/2008/07/the-onion-architecture-part-2/">https://jeffreypalermo.com/2008/07/the-onion-architecture-part-2/</a> (the other parts are good,
too)))</li>
<li>utilities I will probably use in other projects (again, minimal dependencies, and particularly
no dependencies on UI or d/b layers).  Maybe this is where I'd put interface/facade code for
common stuff like logging.</li>
<li>the actual web stuff, which would probably be a pretty thin layer around the business logic.
One exception to the "thin layer" concept is that I guess this is where I'd stick all my
super-fancy javascript UI stuff.  The server would probably concentrate on returning JSON
responses to RESTful (?) queries.</li>
</ul>

<p>
Wonder if I can create these as completely independent of each other (i.e., in different
directories, not subdirectories) and then tie them all together with the parent POM.  See
<a href="https://maven.apache.org/pom.html#Aggregation">https://maven.apache.org/pom.html#Aggregation</a>.  Answer: yes.  (But I'm not doing it right away.)
</p>

<p>
Basically: (1) create a parent project (once), cd into the parent project directory, and (2)
create sub-projects, Archetypes to be used:
</p>

<ul class="org-ul">
<li>maven-archetype-quickstart (parent and jar-type subs)</li>
<li>maven-archetype-webapp (probably just need one of these)</li>
</ul>

<blockquote>
<p>
(Note: there might be some scary warnings at the beginning about HTTPS being required, but it works
ok for setting up the initial project.  In my case, they came from my old <code>.m2</code> repository, and
when I blew it away, the errors cleared up (because new versions got downloaded).)
</p>
</blockquote>

<p>
Then, change the packaging of the parent project to <code>pom</code>, add the subprojects, etc., etc., as
documented at
<a href="https://maven.apache.org/guides/getting-started/index.html#How_do_I_build_more_than_one_project_at_once">https://maven.apache.org/guides/getting-started/index.html#How_do_I_build_more_than_one_project_at_once</a>.
</p>

<p>
<span class="timestamp-wrapper"><span class="timestamp">&lt;2020-03-31 Tue&gt; </span></span> This works.  The trick is to run <code>mvn install</code> at the root (parent) level, so
all depdendent projects <i>plus</i> the parent POM get installed to the local repository (<code>~/.m2</code> by
default).  Apparently, that parent POM is important.
</p>
</div>

<div id="outline-container-orgd51de42" class="outline-5">
<h5 id="orgd51de42"><span class="section-number-5">8.2.2.1</span> Effective POM</h5>
<div class="outline-text-5" id="text-8-2-2-1">
<pre class="example">
mvn help:effective-pom
</pre>


<p>
Shows super-POM merged w/your POM (or inherited POM hierarchy, if you are so bold).
</p>
</div>
</div>

<div id="outline-container-org9c74a1e" class="outline-5">
<h5 id="org9c74a1e"><span class="section-number-5">8.2.2.2</span> Patching up generated POMs</h5>
<div class="outline-text-5" id="text-8-2-2-2">
<p>
Looks like Maven generates POMs that need a little more detail.  (Or sometimes, they have too
much detail, like for really old JDK versions.)
</p>

<p>
I put these property definitions at the end of the "header" section of the POM:
</p>

<div class="org-src-container">
<pre class="src src-xml">&lt;<span style="color: #0000ff;">properties</span>&gt;
  &lt;<span style="color: #0000ff;">maven.compiler.source</span>&gt;11&lt;/<span style="color: #0000ff;">maven.compiler.source</span>&gt;
  &lt;<span style="color: #0000ff;">maven.compiler.target</span>&gt;11&lt;/<span style="color: #0000ff;">maven.compiler.target</span>&gt;
  &lt;<span style="color: #0000ff;">project.build.sourceEncoding</span>&gt;UTF-8&lt;/<span style="color: #0000ff;">project.build.sourceEncoding</span>&gt;
&lt;/<span style="color: #0000ff;">properties</span>&gt;
</pre>
</div>
</div>
</div>

<div id="outline-container-orgd667da9" class="outline-5">
<h5 id="orgd667da9"><span class="section-number-5">8.2.2.3</span> How to define servlets (where the source code goes)</h5>
<div class="outline-text-5" id="text-8-2-2-3">
<p>
Servlet source code goes in web project, in directory
<code>src/main/java/&lt;package-directory-structure&gt;/FooServlet.java</code>.  Binary winds up in the war file
in <code>WEB-INF/classes</code>.
</p>
</div>
</div>

<div id="outline-container-orge0bfa7e" class="outline-5">
<h5 id="how-to-make-javax-servlet-dependencies-available"><span class="section-number-5">8.2.2.4</span> How to make <code>javax.servlet</code> dependencies available</h5>
<div class="outline-text-5" id="text-how-to-make-javax-servlet-dependencies-available">
<p>
Tomcat 9 provides:
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-right" />
</colgroup>
<tbody>
<tr>
<td class="org-left"><b>Spec</b></td>
<td class="org-right"><b>Version</b></td>
</tr>

<tr>
<td class="org-left">Servlet</td>
<td class="org-right">4.0</td>
</tr>

<tr>
<td class="org-left">JSP</td>
<td class="org-right">2.3</td>
</tr>

<tr>
<td class="org-left">EL</td>
<td class="org-right">3.0</td>
</tr>

<tr>
<td class="org-left">WebSocket</td>
<td class="org-right">1.1</td>
</tr>

<tr>
<td class="org-left">JASIC (authentication)</td>
<td class="org-right">1.1</td>
</tr>
</tbody>
</table>

<p>
I'm <i>guessing</i> we won't need the JSP and EL specs, since we'll (probably) be emiting JSON, not
HTML.
</p>

<p>
So, we need something like the following:
</p>

<div class="org-src-container">
<pre class="src src-xml">&lt;<span style="color: #0000ff;">dependency</span>&gt;
  &lt;<span style="color: #0000ff;">groupId</span>&gt;javax.servlet&lt;/<span style="color: #0000ff;">groupId</span>&gt;
  &lt;<span style="color: #0000ff;">artifactId</span>&gt;javax.servlet-api&lt;/<span style="color: #0000ff;">artifactId</span>&gt;
  &lt;<span style="color: #0000ff;">version</span>&gt;3.0.1&lt;/<span style="color: #0000ff;">version</span>&gt;
  &lt;<span style="color: #0000ff;">scope</span>&gt;provided&lt;/<span style="color: #0000ff;">scope</span>&gt;  <span style="color: #36648b; font-style: italic;">&lt;!--  "provided" means we need this JAR for a successful compile, but it won't be included in</span>
<span style="color: #36648b; font-style: italic;">                                 the generated output, because we expect the container to which the generated WAR is</span>
<span style="color: #36648b; font-style: italic;">                                 deployed to provide its own compatible version of the JAR.</span>
<span style="color: #36648b; font-style: italic;">                           --&gt;</span>
&lt;/<span style="color: #0000ff;">dependency</span>&gt;
</pre>
</div>

<p>
But the version we need is probably 4.0.x?
</p>

<p>
The effective POM has Maven Central at <a href="https://repo.maven.apache.org/maven2">https://repo.maven.apache.org/maven2</a>.  So&#x2026; from the
versions listed at <a href="https://repo.maven.apache.org/maven2/javax/servlet/javax.servlet-api/">https://repo.maven.apache.org/maven2/javax/servlet/javax.servlet-api/</a>, it
looks like maybe 4.0.1 is the version we want.
</p>

<p>
Searching at <a href="https://search.maven.org/">https://search.maven.org/</a> with search <code>g:javax.servlet a:javax.servlet-api</code> yields
a hit.  Clicking on the result (try the artifact id or the version count) yields a snippet of
info, including the GitHub repository and home page.
</p>

<p>
And, finally, after all that&#x2026; we build (<code>mvn package</code>), and&#x2026; voila!  (It got automatically
downloaded and the compile succeeds, after we updated our tiny class to have a dependency on
<code>HttpServlet</code>.)
</p>

<pre class="example">
deimos$ pwd
/Users/john/.m2/repository/javax/servlet/javax.servlet-api/4.0.1

deimos$ lscf
_remote.repositories                      javax.servlet-api-4.0.1.jar
javax.servlet-api-4.0.1-javadoc.jar       javax.servlet-api-4.0.1.jar.sha1
javax.servlet-api-4.0.1-javadoc.jar.sha1  javax.servlet-api-4.0.1.pom
javax.servlet-api-4.0.1-sources.jar       javax.servlet-api-4.0.1.pom.sha1
javax.servlet-api-4.0.1-sources.jar.sha1  m2e-lastUpdated.properties
</pre>

<p>
(Whether it runs is something we'll find out later.  (Answer: it does.))
</p>

<p>
The next step, I think, is to fix up routing so a url will go to the servlet.  See <a href="#servlet-routing">Servlet
Routing</a>.
</p>
</div>
</div>

<div id="outline-container-orgf9a6ae9" class="outline-5">
<h5 id="j2ee-project-structure"><span class="section-number-5">8.2.2.5</span> File structure for "simple J2EE" (ha)</h5>
<div class="outline-text-5" id="text-j2ee-project-structure">
<p>
I don't think I need all of the J2EE project stuff, such as the EJBs and the "ear" folder, but
the rest are probably good.  I guess I could just delete the unwanted directories and remove
references to them from the ancester POMs.  Then, the final deliverable is the "servlets" (or
"servlets/servlet") project, packaged as war.
</p>

<p>
The project dir root contains the following (<span class="open-question"> open
questions </span> are presented in the indicated style):
</p>

<ul class="org-ul">
<li>pom.xml &#x2013; overall POM</li>
<li>primary-source &#x2013; core/unique business logic
<ul class="org-ul">
<li>pom.xml &#x2013; sub-POM for the main source, which is a jar</li>
<li>src
<ul class="org-ul">
<li>main
<ul class="org-ul">
<li>java
<ul class="org-ul">
<li>com
<ul class="org-ul">
<li>how_hard_can_it_be.com
<ul class="org-ul">
<li>offtotheraces</li>
</ul></li>
</ul></li>
</ul></li>
</ul></li>
<li>test
<ul class="org-ul">
<li>java</li>
</ul></li>
</ul></li>
<li>target &#x2013; all the magic that Maven does, probably includes the jar generated from primary-source</li>
</ul></li>
<li>projects &#x2013; <span class="open-question"> secondary/reusable source, I guess </span>
<ul class="org-ul">
<li>pom.xml</li>
<li>logging &#x2013; sample project
<ul class="org-ul">
<li>pom.xml &#x2013; each project gets its own POM</li>
<li>src
<ul class="org-ul">
<li>main
<ul class="org-ul">
<li>java</li>
</ul></li>
<li>test
<ul class="org-ul">
<li>java</li>
</ul></li>
</ul></li>
<li>target &#x2013; Maven-generated</li>
</ul></li>
</ul></li>
<li>servlets (plural) &#x2013; actual JSPs and servlets, which should be thin logic around the business
logic.  Note also that, buried below here, are the static files for the web app (js, css,
images, etc.)
<ul class="org-ul">
<li>pom.xml</li>
<li>servlet (singular) &#x2013; <span class="open-question"> Not sure why there's a singular
"servlet" directory under the plural "servlets" directory. </span>
<ul class="org-ul">
<li>src
<ul class="org-ul">
<li>main
<ul class="org-ul">
<li>java</li>
<li>webapp
<ul class="org-ul">
<li>WEB-INF
<ul class="org-ul">
<li>web.xml</li>
</ul></li>
<li>index.jsp</li>
<li><i>(other JSPs and static resources (css, js, images, etc.), presumably</i></li>
</ul></li>
</ul></li>
<li>test
<ul class="org-ul">
<li>java</li>
</ul></li>
</ul></li>
<li>target</li>
</ul></li>
</ul></li>
<li>ejbs &#x2013; <span class="open-question"> I guess these are also thin layers around
business logic </span> 
<ul class="org-ul">
<li>pom.xml</li>
<li>src
<ul class="org-ul">
<li>main
<ul class="org-ul">
<li>java</li>
<li>resource &#x2013; resource bundles for configuration, i18n, similar stuff?
<ul class="org-ul">
<li>META-INF
<ul class="org-ul">
<li>ejb-jar.xml - <span class="open-question"> No idea what this is
</span></li>
</ul></li>
</ul></li>
</ul></li>
<li>test
<ul class="org-ul">
<li>java</li>
</ul></li>
</ul></li>
<li>target</li>
</ul></li>
<li>ear &#x2013; <span class="open-question"> I have no idea what goes in here </span> 
<ul class="org-ul">
<li>pom.xml</li>
<li>src
<ul class="org-ul">
<li>main
<ul class="org-ul">
<li>java</li>
</ul></li>
<li>test
<ul class="org-ul">
<li>java</li>
</ul></li>
</ul></li>
<li>target</li>
</ul></li>
</ul>
</div>
</div>

<div id="outline-container-org74e4bdb" class="outline-5">
<h5 id="org74e4bdb"><span class="section-number-5">8.2.2.6</span> Further info on the "simple" J2EE packaging, from reference docs</h5>
<div class="outline-text-5" id="text-8-2-2-6">
<p>
<a href="https://maven.apache.org/archetypes/maven-archetype-j2ee-simple/index.html">https://maven.apache.org/archetypes/maven-archetype-j2ee-simple/index.html</a>
</p>
</div>
</div>
</div>

<div id="outline-container-orgdcffa2b" class="outline-4">
<h4 id="orgdcffa2b"><span class="section-number-4">8.2.3</span> Reactor?  What's that?</h4>
<div class="outline-text-4" id="text-8-2-3">
<p>
Built-in part of Maven that decides in what order to build component modules (sub-projects),
given their interdependencies.  Not a plug-in; don't sweat it.
</p>
</div>
</div>

<div id="outline-container-orgabaabe6" class="outline-4">
<h4 id="orgabaabe6"><span class="section-number-4">8.2.4</span> Useful sites</h4>
<div class="outline-text-4" id="text-8-2-4">
<ul class="org-ul">
<li><a href="https://mvnrepository.com">https://mvnrepository.com</a></li>

<li><a href="https://repo.maven.apache.org/maven2/">https://repo.maven.apache.org/maven2/</a></li>

<li><a href="https://search.maven.org/">https://search.maven.org/</a> (i.e., Sonatype, a major supporter of Maven)</li>

<li><a href="https://javadoc.io/">https://javadoc.io/</a></li>
</ul>
</div>
</div>
</div>
</div>

<div id="outline-container-org2463900" class="outline-2">
<h2 id="org2463900"><span class="section-number-2">9</span> Version Control</h2>
<div class="outline-text-2" id="text-9">
</div>
<div id="outline-container-orgaded5d4" class="outline-3">
<h3 id="orgaded5d4"><span class="section-number-3">9.1</span> Git mechanics</h3>
<div class="outline-text-3" id="text-9-1">
<p>
(Apart from the basics of <code>git commit</code>.)
</p>
</div>

<div id="outline-container-org73fa9a8" class="outline-4">
<h4 id="org73fa9a8"><span class="section-number-4">9.1.1</span> New branch w/current outstanding changes</h4>
<div class="outline-text-4" id="text-9-1-1">
<p>
When you decide you're half-baked changes really should go into a separate branch.
</p>

<p>
:git checkout -b &lt;new-branch-name&gt;
</p>
</div>
</div>

<div id="outline-container-orgbf4dba4" class="outline-4">
<h4 id="orgbf4dba4"><span class="section-number-4">9.1.2</span> Merge another branch or commit into the current branch</h4>
<div class="outline-text-4" id="text-9-1-2">
<p>
When you decide the work on a branch is complete and should be merged into main ("master")
</p>

<p>
:git merge &lt;commit&gt;
</p>

<p>
Where <i>&lt;commit&gt;</i> is either the name of another branch (will merge entire branch) or (maybe?) the
hash of another commit.
</p>
</div>
</div>

<div id="outline-container-orgdbaeab1" class="outline-4">
<h4 id="orgdbaeab1"><span class="section-number-4">9.1.3</span> See the list of commits</h4>
<div class="outline-text-4" id="text-9-1-3">
<p>
:git log
</p>

<p>
Gives the commit hash associated w/each commit, and you can use that hashes in other <code>git</code> commands.
</p>
</div>
</div>

<div id="outline-container-org2adcf0e" class="outline-4">
<h4 id="org2adcf0e"><span class="section-number-4">9.1.4</span> Restore working dir to match an old version</h4>
<div class="outline-text-4" id="text-9-1-4">
<p>
:git checkout &lt;commit&gt;
</p>

<p>
Where <i>&lt;commit&gt;</i> is the hash of the old commit you want.  Note that <i>&lt;commit&gt;</i> could also be the
name of another branch, in which case you get the head of that branch.    
</p>
</div>
</div>
</div>
</div>

<div id="outline-container-org4c63cb1" class="outline-2">
<h2 id="org4c63cb1"><span class="section-number-2">10</span> App code</h2>
<div class="outline-text-2" id="text-10">
<p>
Because this is where it gets real.  Notes in this section are more code-centered than in the previous sections.
</p>

<p>
Note that, at some point, I switched over to using JetBrains's IntelliJ IDEA community-edition
Java IDE, and it started getting magic.  In particular, it can be set to automatically download
Maven artifacts as you include them in the POM, so you no longer see them get downloaded as part
of your Maven build process.
</p>
</div>

<div id="outline-container-org830b5fe" class="outline-3">
<h3 id="hello-world"><span class="section-number-3">10.1</span> Simplest possible code</h3>
<div class="outline-text-3" id="text-hello-world">
<div class="org-src-container">
<pre class="src src-java"><span style="color: #008b8b;">@WebServlet</span>(urlPatterns = { <span style="color: #b22222;">"/hello"</span> })
<span style="color: #a020f0;">public</span> <span style="color: #a020f0;">class</span> <span style="color: #228b22;">HelloServlet</span> <span style="color: #a020f0;">extends</span> <span style="color: #228b22;">HttpServlet</span>
{
   <span style="color: #a020f0;">public</span> <span style="color: #228b22;">void</span> <span style="color: #0000ff;">doGet</span>(<span style="color: #228b22;">HttpServletRequest</span> <span style="color: #8b6914;">aRequest</span>, <span style="color: #228b22;">HttpServletResponse</span> <span style="color: #8b6914;">aResponse</span>) 
      <span style="color: #a020f0;">throws</span> <span style="color: #228b22;">ServletException</span>, <span style="color: #228b22;">IOException</span>
   {
      aRequest.getServletContext().getRequestDispatcher(<span style="color: #b22222;">"/index.jsp"</span>).forward(aRequest, aResponse);
   }
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org4dcdea3" class="outline-3">
<h3 id="org4dcdea3"><span class="section-number-3">10.2</span> Other aspects to consider</h3>
<div class="outline-text-3" id="text-10-2">
</div>
<div id="outline-container-orgf627d26" class="outline-4">
<h4 id="orgf627d26"><span class="section-number-4">10.2.1</span> Packaging &#x2013; how the entire project is structured</h4>
<div class="outline-text-4" id="text-10-2-1">
<p>
Maybe&#x2026; web stuff in the war, but business logic and persistence in other jars?  Yes, see
<a href="#maven">Maven</a> (specifically, <a href="#maven-project-structure">Make a project</a>).
</p>
</div>
</div>

<div id="outline-container-org35852e5" class="outline-4">
<h4 id="servlet-routing"><span class="section-number-4">10.2.2</span> Servlet Routing</h4>
<div class="outline-text-4" id="text-servlet-routing">
<p>
How to define routings so that URLs map to servlets.
</p>

<p>
Servlet mappings.  Chapter 12 of the Servlet 4.0 spec, available at
<a href="https://javaee.github.io/servlet-spec/downloads/servlet-4.0/servlet-4_0_FINAL.pdf">https://javaee.github.io/servlet-spec/downloads/servlet-4.0/servlet-4_0_FINAL.pdf</a>.
</p>

<p>
Also, use the <code>WebServlet</code> annotation to specify mappings at the level of each servlet, so you
don't have to go edit <code>web.xml</code>.
</p>
</div>
</div>

<div id="outline-container-org9e260ec" class="outline-4">
<h4 id="org9e260ec"><span class="section-number-4">10.2.3</span> JSON output</h4>
<div class="outline-text-4" id="text-10-2-3">
<p>
Is there an easy way?  Or do I just call <code>toJson()</code> on some object and write it to the response
stream?
</p>

<p>
Actually, it looks pretty simple.
</p>

<p>
See <a href="https://www.baeldung.com/servlet-json-response">https://www.baeldung.com/servlet-json-response</a>, but basically, it's:
</p>

<div class="org-src-container">
<pre class="src src-java"><span style="color: #228b22;">String</span> <span style="color: #8b6914;">employeeJsonString</span> = <span style="color: #a020f0;">new</span> <span style="color: #228b22;">Gson</span>().toJson(employee);
<span style="color: #228b22;">PrintWriter</span> <span style="color: #8b6914;">out</span> = response.getWriter();
response.setContentType(<span style="color: #b22222;">"application/json"</span>);
response.setCharacterEncoding(<span style="color: #b22222;">"UTF-8"</span>);
out.print(employeeJsonString);
out.flush();
</pre>
</div>

<p>
<i>Gson</i> is Google's JSON serializer.  <i>Jackson</i> is the more "standard" java-world serializer,
and, like all things Java-world, it's both more complex and more powerful (I guess).
</p>
</div>
</div>

<div id="outline-container-org973cb8d" class="outline-4">
<h4 id="org973cb8d"><span class="section-number-4">10.2.4</span> <span class="done DONE">DONE</span> Dependency Injection</h4>
<div class="outline-text-4" id="text-10-2-4">
<p>
Implementations of CDI spec.
</p>

<p>
Servlet construction-time parameters, injection?
</p>

<p>
Or do we just have a global resolver and use it all over the place?
</p>

<p>
Note that the full-blown CDI spec builds on the "dependency injection" spec, so we may not need
the full-blown CDI.  (On the other hand, maybe we <i>do</i> want to go ahead and use it, so we don't
have to make the transition to it later, when my project becomes a huge enterprise church CRM
system with thousands of subscribers.  Or just so I can learn it.)
</p>
</div>

<div id="outline-container-org52e8cf9" class="outline-5">
<h5 id="org52e8cf9"><span class="section-number-5">10.2.4.1</span> Setup</h5>
<div class="outline-text-5" id="text-10-2-4-1">
<p>
Supposedly simple tutorial at <a href="https://hradecek.github.io/posts/cdi-in-tomcat">https://hradecek.github.io/posts/cdi-in-tomcat</a>.
</p>

<p>
Also, the Weld reference manual has info in the chapter on "Application servers and environments
supported by Weld" (specifically, the sections on "Servlet containers" and "Tomcat").  It's
mostly a matter of adding the Maven dependency blobs specified in the reference manual to your
pom.xml, web.xml, and context.xml.
</p>
</div>

<div id="outline-container-org9760b88" class="outline-6">
<h6 id="org9760b88"><span class="section-number-6">10.2.4.1.1</span> <span class="done DONE">DONE</span> Creating injected beans in another module</h6>
<div class="outline-text-6" id="text-10-2-4-1-1">
<p>
Trying to move injected beans to another module (jar packaging) and I need to get a
META-INF/beans.xml file in it, somehow (I think).
</p>

<p>
Answer: <code>META-INF</code> goes in <code>resources</code> directory, a <i>peer</i> to the <code>java</code> directory.  Only java
code goes in <code>java</code> directory.  See <a href="https://stackoverflow.com/a/13057183">https://stackoverflow.com/a/13057183</a>.
</p>
</div>

<div id="outline-container-orge840553" class="outline-7">
<h7 id="orge840553"><span class="section-number-7">10.2.4.1.1.1</span> <span class="done RESEARCH_DONE">RESEARCH-DONE</span> Bean scoping</h7>
<div class="outline-text-7" id="text-10-2-4-1-1-1">
<p>
I have a bean injected as the private data member of a servlet.  Is there a default scope?
What is it?  Should I explicitly scope my bean?  To <code>@Dependent</code>, maybe?
</p>

<p>
Actually, probably not <code>@Dependent</code>, because most of the beans will already have some sort of
preconceived scope, probably one of either <code>@ApplicationScoped</code> or <code>@RequestScoped</code>.  Note,
also, that scoping happens where the bean is defined, not at the injection point (I think).
</p>

<p>
(Ideally, we'd stay away from HTTP sessions, because
</p>

<ol class="org-ol">
<li>They break load-balancing, unless you set session affinity for nodes in a farm;</li>
<li>They could, <i>conceivably</i> suck up a bunch of memory if you jam a bunch of stuff in the
session; and (surprisingly)</li>
<li>If you have multiple simultaneous incoming requests (like a bunch of DIVs loaded with AJAX
calls), they can wind up either blocking on the session (single-threading) or overwriting
it with gay abandon, both of which are Bad Things.</li>
</ol>

<p>
)
</p>
</div>
</div>

<div id="outline-container-orge34f4b9" class="outline-7">
<h7 id="orge34f4b9"><span class="section-number-7">10.2.4.1.1.2</span> <span class="todo HOLD">HOLD</span> <code>beans.xml</code> is optional, supposedly</h7>
<div class="outline-text-7" id="text-10-2-4-1-1-2">
<ul class="org-ul">
<li>State "HOLD"       from "TODO"       <span class="timestamp-wrapper"><span class="timestamp">[2020-04-25 Sat 13:06] </span></span> <br />
For now, I'll just live with plonking an empty <code>beans.xml</code> file in every module that has injection
beans.</li>
</ul>

<p>
I guess that means all beans have to have scope annotations?  Is there a more generic
<code>@InjectedBean</code> annotation I can use, or do I just slap on scope annotations?
</p>
</div>
</div>
</div>
</div>

<div id="outline-container-org2a6b7ef" class="outline-5">
<h5 id="org2a6b7ef"><span class="section-number-5">10.2.4.2</span> Background info</h5>
<div class="outline-text-5" id="text-10-2-4-2">
<p>
From <a href="https://projects.eclipse.org/proposals/jakarta-contexts-and-dependency-injection">https://projects.eclipse.org/proposals/jakarta-contexts-and-dependency-injection</a>:
</p>

<blockquote>
<p>
Unlike most of the Java EE specifications, Contexts and Dependency Injection was led by a
non-Oracle organization, namely Red Hat.
</p>

<p>
The project aims to continue the standardization work of the Contexts and Dependency Injection
(CDI) specification, which is part of the Java EE platform, but which also is designed since
version 2.0 for use in Java SE environments. Previous revisions of that specification were
created under the Java Community Process (JCP):
</p>

<ul class="org-ul">
<li>CDI 1.0 (JSR 299), part of Java EE 6</li>
<li>CDI 1.1 and 1.2 (JSR 346), part of Java EE 7</li>
<li>CDI 2.0 (JSR 365), part of Java EE 8</li>
</ul>
</blockquote>
</div>
</div>
</div>

<div id="outline-container-orgc0c9e57" class="outline-4">
<h4 id="orgc0c9e57"><span class="section-number-4">10.2.5</span> <span class="done DONE">DONE</span> Persistence</h4>
<div class="outline-text-4" id="text-10-2-5">
<ul class="org-ul">
<li>CLOSING NOTE <span class="timestamp-wrapper"><span class="timestamp">[2020-04-21 Tue 22:29] </span></span> <br />
Problems solved.  Still need to tackle JPA (below).</li>
</ul>
</div>

<div id="outline-container-org12da0cf" class="outline-5">
<h5 id="org12da0cf"><span class="section-number-5">10.2.5.1</span> <span class="done DONE">DONE</span> SQLite (for now)</h5>
<div class="outline-text-5" id="text-10-2-5-1">
<ul class="org-ul">
<li>CLOSING NOTE <span class="timestamp-wrapper"><span class="timestamp">[2020-04-12 Sun 12:17] </span></span> <br />
Picked SQLite, now handling sub-issues (see below).</li>
</ul>

<p>
But maybe Derby later as an exercise in another d/b layer.
</p>
</div>

<div id="outline-container-org80e85b7" class="outline-6">
<h6 id="org80e85b7"><span class="section-number-6">10.2.5.1.1</span> <span class="done DONE">DONE</span> Create a play sqlite database</h6>
<div class="outline-text-6" id="text-10-2-5-1-1">
<p>
Before we play around with JPQL and EclipseLink and all that, we need a database.  The one
from <a href="http://tarheel-nc.s3-website-us-east-1.amazonaws.com/sql-basics.html">http://tarheel-nc.s3-website-us-east-1.amazonaws.com/sql-basics.html</a> should do.
</p>

<p>
But first, since "Entity" is such a terrible name for entities, I edited the "load" sql script
to replace "Entity" with "Monster", so it's a database of monsters, with tags.
</p>

<p>
To load it&#x2026; use SQLite Studio.  (Or you could do it from the command line, I guess, but I
don't know how to do that easily.)
</p>

<p>
Create a new database and connect to it.
</p>

<p>
Open a SQL editor, load the "load" file, select all the text and run it.  (Apparently, running
w/out selecting all text results in only one statement being run.)
</p>

<p>
Results in a 28k database file, so, not too big.
</p>
</div>

<div id="outline-container-org28d0022" class="outline-7">
<h7 id="org28d0022"><span class="section-number-7">10.2.5.1.1.1</span> <span class="done DONE">DONE</span> Where to put it?</h7>
<div class="outline-text-7" id="text-10-2-5-1-1-1">
<ul class="org-ul">
<li>CLOSING NOTE <span class="timestamp-wrapper"><span class="timestamp">[2020-04-21 Tue 21:51] </span></span> <br />
Answer: put it in some directory path completely independent of the webapp, make sure tomcat user
has read/write access, and specify the path to it in a JDBC connection url in webapp config files.
Preferred approach with Tomcat is to put it in <code>context.xml</code>, which can optionally be extracted to a
directory below the Tomcat <code>conf</code> directory, so it <i>might</i> be persistent across app version upgrades
(that last part still needs testing).</li>
</ul>

<p>
I dunno, but probably not in the resource directory, since that'll be inside the jar and
probably not updateable.  Maybe put an empty copy of the d/b in the resources directory so at
runtime, it can be used as a template for a new d/b (if needed), and have a property
specifying the location of the actual d/b somewhere?
</p>

<p>
Which begs the question: how to specify properties, both outside (actual value) and inside
(default value) the jar?
</p>
</div>

<div id="outline-container-org858826c" class="outline-8">
<h8 id="org858826c"><span class="section-number-8">10.2.5.1.1.1.1</span> <span class="done DONE">DONE</span> jar properties</h8>
<div class="outline-text-8" id="text-10-2-5-1-1-1-1">
<ul class="org-ul">
<li>CLOSING NOTE <span class="timestamp-wrapper"><span class="timestamp">[2020-04-12 Sun 15:06] </span></span> <br />
Not the answer.</li>
</ul>

<p>
The property I want is the location of the database.
</p>

<p>
Actually, this isn't the answer, but read on (<a href="#command-line-properties">Command-line (or otherwise run-time) properties</a>).
</p>
</div>
</div>

<div id="outline-container-orgf17b407" class="outline-8">
<h8 id="command-line-properties"><span class="section-number-8">10.2.5.1.1.1.2</span> <span class="done DONE">DONE</span> Command-line (or otherwise run-time) properties</h8>
<div class="outline-text-8" id="text-command-line-properties">
<ul class="org-ul">
<li>CLOSING NOTE <span class="timestamp-wrapper"><span class="timestamp">[2020-04-21 Tue 21:49] </span></span> <br />
Not the answer.  Webapp config files (web.xml, context.xml) are the answer.</li>
</ul>

<p>
<code>System.getProperty()</code> ?
</p>

<p>
Gets more complicated for a webapp, because you don't get a command line to fiddle around
with.  And, even if you did, Tomcat hosts multiple web apps, so anything on the command line
(or in server.xml, for that matter) would be global to everything.
</p>

<p>
TODO: Interesting side note: what happens if any code in a Tomcat webapp calls
<code>System.exit()</code>?  Does all of Tomcat shut down?
</p>

<p>
Looks like the answer is JNDI (great! another thing to learn!)
</p>

<p>
See <a href="#tomcat-jndi-resources">JDBC connection and other external configs preserved between version upgrade</a>.
</p>

<p>
Turns out the answer is what the Tomcat docs say
(<a href="https://tomcat.apache.org/tomcat-9.0-doc/jndi-resources-howto.html#JDBC_Data_Sources">https://tomcat.apache.org/tomcat-9.0-doc/jndi-resources-howto.html#JDBC_Data_Sources</a>):  put
the context in a <code>&lt;Context&gt;</code> element in <code>context.xml</code>.  As opposed to some post on
StackOverflow saying to put it in <code>GlobalNamingResources</code> in <code>server.xml</code>.
</p>
</div>
</div>
</div>
</div>
</div>

<div id="outline-container-orgf73bc75" class="outline-5">
<h5 id="orgf73bc75"><span class="section-number-5">10.2.5.2</span> <span class="done DONE">DONE</span> Connect to SQLite d/b using JDBC</h5>
<div class="outline-text-5" id="text-10-2-5-2">
</div>

<div id="outline-container-org597dd4d" class="outline-6">
<h6 id="org597dd4d"><span class="section-number-6">10.2.5.2.1</span> <span class="done DONE">DONE</span> sqlite driver</h6>
<div class="outline-text-6" id="text-10-2-5-2-1">
<ul class="org-ul">
<li>State "HOLD"       from "IN-PROGRESS" <span class="timestamp-wrapper"><span class="timestamp">[2020-04-14 Tue 13:01] </span></span> <br />
Found a way to connect, theoretically; now just waiting to see if it actually works (depends on writing a bunch of other
code, under other items).</li>
</ul>

<p>
Looks like the Xerial one is the most commonly-used.  Not hard to find at <a href="https://mvnrepository.com">https://mvnrepository.com</a>.
</p>
</div>
</div>

<div id="outline-container-org0617a1f" class="outline-6">
<h6 id="org0617a1f"><span class="section-number-6">10.2.5.2.2</span> <span class="done DONE">DONE</span> Getting DataSource from JNDI at the right time</h6>
<div class="outline-text-6" id="text-10-2-5-2-2">
<ul class="org-ul">
<li>CLOSING NOTE <span class="timestamp-wrapper"><span class="timestamp">[2020-04-29 Wed 14:36] </span></span> <br />
(Solved a week or two ago, but merging notes between two machines and may have lost the timestamp on this.)</li>
</ul>

<p>
"Right time", ha.
</p>

<p>
I guess we'd need a very short-life-cycle bean to be injected and broken down after a single "read" or "write"
method.  For sqlite write, we probably want to use a transaction, for efficiency during concurrent access.  Do we
want to inject it as a method parameter?  And then we'd need to know whether it's for read or write (write
requires transaction).
</p>

<p>
And&#x2026; why are we doing this with bean injection?  Because we don't know which d/b we'll be hitting (sqlite,
postgres, &#x2026;), so we can't hardcode the d/b connection setup.
</p>
</div>
</div>
</div>

<div id="outline-container-org9cf4973" class="outline-5">
<h5 id="org9cf4973"><span class="section-number-5">10.2.5.3</span> <span class="done DONE">DONE</span> Java Persistence API (JPA)</h5>
<div class="outline-text-5" id="text-10-2-5-3">
<ul class="org-ul">
<li>CLOSING NOTE <span class="timestamp-wrapper"><span class="timestamp">[2020-05-09 Sat 22:12] </span></span> <br />
CDI problem fixed last weekend, I think.</li>
<li>State "HOLD"       from "TODO"       <span class="timestamp-wrapper"><span class="timestamp">[2020-05-03 Sun 19:54] </span></span> <br />
Straightening out problem with CDI bean and interface in separate modules.</li>
</ul>
</div>

<div id="outline-container-org4c088db" class="outline-6">
<h6 id="org4c088db"><span class="section-number-6">10.2.5.3.1</span> "Criteria" queries:  Yikes.</h6>
<div class="outline-text-6" id="text-10-2-5-3-1">
<p>
Typesafe queries, but it seems (a) like a lot of work, and (b) to assume I have a knowledge of
JPQL.  Accordingly, let's learn about JPQL first.
</p>
</div>
</div>

<div id="outline-container-orgbcee728" class="outline-6">
<h6 id="orgbcee728"><span class="section-number-6">10.2.5.3.2</span> <span class="done DONE">DONE</span> JPQL</h6>
<div class="outline-text-6" id="text-10-2-5-3-2">
<ul class="org-ul">
<li>CLOSING NOTE <span class="timestamp-wrapper"><span class="timestamp">[2020-04-09 Thu 15:27] </span></span> <br />
Well, I <b>read</b> about it.</li>
</ul>

<p>
Java Persistence Query Language.  Requires typecasting of query results, but is closer to SQL,
so maybe easier to learn.
</p>

<p>
(Obviously, the advantage of abstracting over the particular relational d/b is the code can be
neutral with respect to vendor SQL dialects.)
</p>
</div>

<div id="outline-container-org77de68c" class="outline-7">
<h7 id="jpql-fetch-plan"><span class="section-number-7">10.2.5.3.2.1</span> <span class="todo TODO">TODO</span> fetch plans</h7>
<div class="outline-text-7" id="text-jpql-fetch-plan">
<p>
Need to figure out how to get these (and whether they're useful).
</p>
</div>
</div>

<div id="outline-container-org887824f" class="outline-7">
<h7 id="org887824f"><span class="section-number-7">10.2.5.3.2.2</span> <span class="done DONE">DONE</span> EclipseLink</h7>
<div class="outline-text-7" id="text-10-2-5-3-2-2">
<ul class="org-ul">
<li>CLOSING NOTE <span class="timestamp-wrapper"><span class="timestamp">[2020-05-09 Sat 17:07] </span></span> <br />
persistence.xml needs full JNDI path to DataSource: java:comp/env/jdbc/LayLeadership.</li>
<li>State "HOLD"       from "TODO"       <span class="timestamp-wrapper"><span class="timestamp">[2020-05-03 Sun 19:53] </span></span> <br />
Need to figure out what went wrong with my attempt to separate CDI bean from interface
(module-wise).</li>
<li>State "HOLD"       from "IN-PROGRESS" <span class="timestamp-wrapper"><span class="timestamp">[2020-04-10 Fri 17:50] </span></span> <br />
Waiting for a simple JDBC connection.</li>
</ul>

<p>
Need to get started writing some code with this.
</p>

<p>
<span class="timestamp-wrapper"><span class="timestamp">&lt;2020-04-25 Sat&gt; </span></span> Ok, now that I've got a working JDBC query, time to turn it into a JPQL query.
</p>
</div>

<div id="outline-container-org627b56b" class="outline-8">
<h8 id="eclipselink-download-and-install"><span class="section-number-8">10.2.5.3.2.2.1</span> <span class="done DONE">DONE</span> Download &amp; install</h8>
<div class="outline-text-8" id="text-eclipselink-download-and-install">
<ul class="org-ul">
<li>CLOSING NOTE <span class="timestamp-wrapper"><span class="timestamp">[2020-05-09 Sat 17:08] </span></span> <br />
Yes, this can be done with Maven dependencies (i.e, just a POM edit, no need for separate download).</li>
<li>State "HOLD"       from "TODO"       <span class="timestamp-wrapper"><span class="timestamp">[2020-05-02 Sat 19:50] </span></span> <br />
Waiting to see if just adding Maven dependencies handles this.</li>
</ul>

<p>
<del>Bleah, maybe I should start with a simple JDBC connection before I go crazy on JPA.</del> Well,
I'm working on it now (<span class="timestamp-wrapper"><span class="timestamp">&lt;2020-05-02 Sat&gt;</span></span>).  I probably don't need an explicit
downlod-and-install step; I can probably just add Maven dependencies and be off to the
races.
</p>
</div>
</div>

<div id="outline-container-org3873c50" class="outline-8">
<h8 id="org3873c50"><span class="section-number-8">10.2.5.3.2.2.2</span> <span class="done DONE">DONE</span> Add EclipseLink to build/deploy</h8>
<div class="outline-text-8" id="text-10-2-5-3-2-2-2">
<ul class="org-ul">
<li>CLOSING NOTE <span class="timestamp-wrapper"><span class="timestamp">[2020-05-09 Sat 17:09] </span></span> <br />
See <a href="web-app-journal.html#eclipselink-download-and-install">Download &amp; install</a>.</li>
</ul>
</div>
</div>

<div id="outline-container-orgf247e98" class="outline-8">
<h8 id="orgf247e98"><span class="section-number-8">10.2.5.3.2.2.3</span> <span class="done DONE">DONE</span> Use EclipseLink in code</h8>
<div class="outline-text-8" id="text-10-2-5-3-2-2-3">
<ul class="org-ul">
<li>CLOSING NOTE <span class="timestamp-wrapper"><span class="timestamp">[2020-05-09 Sat 22:35] </span></span> <br />
Might want to consider using Derby instead of Sqlite, since EclipseLink doesn't exactly support Sqlite.</li>
<li>CLOSING NOTE <span class="timestamp-wrapper"><span class="timestamp">[2020-05-09 Sat 17:09] </span></span> <br />
Don't need EclipseLink, per se, just standard JPA (JPQL) stuff.</li>
</ul>

<p>
Note, though, that you probably need to specify the exact database you're connecting to, so EclipseLink can know
which dialect of SQL to utter.
</p>

<pre class="example">
[EL Info]: connection: 2020-05-09 22:02:11.498--Thread(Thread[http-nio-8080-exec-23,5,main])--Not able to detect
platform for vendor name [SQLite[3.30.1, 3]]. Defaulting to
[org.eclipse.persistence.platform.database.DatabasePlatform]. The database dialect used may not match with the database
you are using. Please explicitly provide a platform using property "eclipselink.target-database".
</pre>

<p>
(Word-wrapped for readability.  In real life, this is one long log line.)
</p>

<p>
Here are the possible values for <code>eclipselink.target-database</code>:
<a href="https://www.eclipse.org/eclipselink/documentation/2.7/jpa/extensions/persistenceproperties_ref.htm#target-database">https://www.eclipse.org/eclipselink/documentation/2.7/jpa/extensions/persistenceproperties_ref.htm#target-database</a>.
</p>

<p>
Note that Sqlite isn't an option, but Derby is.  Argument for using Derby instead of Sqlite.  Interesting
StackOverflow post:  <a href="https://stackoverflow.com/a/12496259">https://stackoverflow.com/a/12496259</a>.
</p>
</div>
</div>
</div>
</div>

<div id="outline-container-org36096d5" class="outline-6">
<h6 id="org36096d5"><span class="section-number-6">10.2.5.3.3</span> <span class="done DONE">DONE</span> Hooking it up</h6>
<div class="outline-text-6" id="text-10-2-5-3-3">
<ul class="org-ul">
<li>CLOSING NOTE <span class="timestamp-wrapper"><span class="timestamp">[2020-05-09 Sat 17:39] </span></span> <br />
This is done, but I'm not super-happy with it.  The <code>@PersistenceUnit</code> annotation in the Sqlite repository isn't
working, so we have to have Java code in the SqliteRepository, and an explicit reference to the JNDI DataSource
via a full JNDI path in the <code>non-jta-data-source</code> element in <code>persistence.xml</code>.  See <a href="#making-weld-process-data-jar">Injection of Persistent
Unit via annotations, w/out code</a>.</li>
</ul>

<p>
JTA is not available in Tomcat.  So we need a <code>non-jta-data-source</code>.
</p>

<ul class="org-ul">
<li class="on"><code>[X]</code> Need a <code>persistence.xml</code>.
<ul class="org-ul">
<li>Non-JTA datasource is specified with full JNDI path: <code>java:comp/env/jdbc/LayLeadership</code>.</li>
</ul></li>
<li class="on"><code>[X]</code> Need a persistence unit
<ul class="org-ul">
<li>In <code>persistence.xml</code>, above.</li>
</ul></li>
<li class="on"><code>[X]</code> Need the right JARs
<ul class="org-ul">
<li>Maven dependencies suffice.</li>
</ul></li>
</ul>
</div>

<div id="outline-container-orgdca5fb3" class="outline-7">
<h7 id="orgdca5fb3"><span class="section-number-7">10.2.5.3.3.1</span> <span class="todo TODO">TODO</span> Transactions</h7>
<div class="outline-text-7" id="text-10-2-5-3-3-1">
<p>
There is a java:comp/UserTransaction binding at run-time, with type <code>org.apache.naming.TransactionRef</code>.  We
should find out if that's useful (surely yes, right?).
</p>

<p>
Supposedly, SQLite gets a lot more efficient if you can wrap writes in a transaction.  This is probably also tied
up with the <a href="#jpql-fetch-plan">fetch plans</a>.
</p>

<p>
Looks like just calling <code>EntityManager.getTransaction()</code> works.  At least, the code runs w/out error.
</p>
</div>
</div>

<div id="outline-container-orga5b5226" class="outline-7">
<h7 id="making-weld-process-data-jar"><span class="section-number-7">10.2.5.3.3.2</span> <span class="done DONE">DONE</span> Injection of Persistent Unit via annotations, w/out code (even a <code>@PostConstruct</code> method)</h7>
<div class="outline-text-7" id="text-making-weld-process-data-jar">
<ul class="org-ul">
<li>State "HOLD"       from "IN-PROGRESS" <span class="timestamp-wrapper"><span class="timestamp">[2020-05-10 Sun 12:51] </span></span> <br />
Giving up.  Maybe it's because Tomcat isn't a full-blown EE container, even though I <i>am</i> using CDI
(Weld).</li>
</ul>

<p>
Everything I read says this is impossible with Tomcat, so I guess I should give up and move on.
</p>

<p>
We currently are able to have code create an EntityManager via direct reference to JNDI DataSource, which, I
guess, is ok, but we should be able to use the <code>@PersistenceUnit</code> annotation w/out needing code to create the
EntityManagerFactory.
</p>

<div class="org-src-container">
<pre class="src src-java"><span style="color: #a020f0;">import</span> <span style="color: #008b8b;">javax</span>.<span style="color: #008b8b;">persistence</span>.<span style="color: #228b22;">Persistence</span>;

<span style="color: #a020f0;">if</span> (_entityMgrFactory == <span style="color: #008b8b;">null</span>)
   _entityMgrFactory = Persistence.createEntityManagerFactory( <span style="color: #b22222;">"LayLeadership"</span> );

<span style="color: #228b22;">EntityManager</span> <span style="color: #8b6914;">em</span> = _entityMgrFactory.createEntityManager();
</pre>
</div>

<p>
(Note: the above conditional code can go in a <code>@PostConstruct</code> method, and at least we're playing along with
CDI.)
</p>

<p>
Need to find out:
</p>

<ol class="org-ol">
<li>Whether this is even possible with Tomcat (which is not a full EE container) [answer: yes, it seems to be
possible], and, if so,</li>
<li>How to do it [see below].</li>
</ol>

<p>
(See <a href="https://www.logicbig.com/tutorials/java-ee-tutorial/jpa/entity-context.html">https://www.logicbig.com/tutorials/java-ee-tutorial/jpa/entity-context.html</a>, but it doesn't have any
immediate bearing on the current problem.)
</p>
</div>

<div id="outline-container-orgc9a4600" class="outline-8">
<h8 id="orgc9a4600"><span class="section-number-8">10.2.5.3.3.2.1</span> Do I need to include Weld as a dependecy in any module (e.g., <code>Data</code>) I want to get "cascading" injection in?  (Answer: NO.)</h8>
<div class="outline-text-8" id="text-10-2-5-3-3-2-1">
<p>
I tried it, and, for one brief shining moment, it was working, but I didn't understand why.  The next morning, I
remembered the bit about running <code>mvn clean</code> after changing module dependencies, so I did, and now&#x2026; we're
broken again, even though I included the Weld dependency in the Data module.  So&#x2026; yay?  Consistency?
</p>

<p>
Ah.  Ok, I figured out why it worked the 2nd time (duh):  The bean (<code>LayLeadershipSqliteRepository</code>) is
<i>application</i> scoped, so, once I initialized it, it stayed initialized.  Duh.  (I'm actually kind of relieved I
understand at least this second mystery.)
</p>

<p>
So, the problem remains and I can take the Weld dependency out of Data (see yesterday's (<span class="timestamp-wrapper"><span class="timestamp">&lt;2020-05-09 Sat&gt;</span></span>)
stupid notes, below).
</p>
</div>

<div id="outline-container-org39777a7" class="outline-9">
<h9 id="org39777a7"><span class="section-number-9">10.2.5.3.3.2.1.1</span> Old notes from <span class="timestamp-wrapper"><span class="timestamp">&lt;2020-05-09 Sat&gt;</span></span>, mostly ignorable</h9>
<div class="outline-text-9" id="text-10-2-5-3-3-2-1-1">
<p>
YES.  Add the following dependency to the <code>Data</code> module POM, which is copied from the <code>Web</code> module POM (so we
don't get version-mismatch issues):
</p>

<div class="org-src-container">
<pre class="src src-xml">&lt;<span style="color: #0000ff;">dependency</span>&gt;
  &lt;<span style="color: #0000ff;">groupId</span>&gt;org.jboss.weld.servlet&lt;/<span style="color: #0000ff;">groupId</span>&gt;
  &lt;<span style="color: #0000ff;">artifactId</span>&gt;weld-servlet-core&lt;/<span style="color: #0000ff;">artifactId</span>&gt;
  &lt;<span style="color: #0000ff;">version</span>&gt;3.1.4.Final&lt;/<span style="color: #0000ff;">version</span>&gt;
  &lt;<span style="color: #0000ff;">scope</span>&gt;runtime&lt;/<span style="color: #0000ff;">scope</span>&gt;
&lt;/<span style="color: #0000ff;">dependency</span>&gt;
</pre>
</div>

<p>
Note that the word "servlet" in groupId and artifactId refers to the fact that Tomcat is a "servlet container",
in JBoss's terminology, as opposed to a full-blown Java/Jakarta EE container.
</p>

<p>
Why this works is beyond me.  It doesn't seem to include the Weld jars in the generated Data.jar.  Somehow, it
brings classes in the <code>Data.jar</code> into Weld's domain.
</p>
</div>
</div>
</div>

<div id="outline-container-orgece1867" class="outline-8">
<h8 id="orgece1867"><span class="section-number-8">10.2.5.3.3.2.2</span> Do I need to explicitly declare the <code>@PersistenceUnit</code> of type <code>EntityManagerFactory</code> an injection point with <code>@Inject</code>? Answer: NO)</h8>
<div class="outline-text-8" id="text-10-2-5-3-3-2-2">
<pre class="example">
Caused by: org.jboss.weld.exceptions.DeploymentException: WELD-001408: Unsatisfied dependencies for type EntityManagerFactory with qualifiers @Default
at injection point [BackedAnnotatedField] @Inject @PersistenceUnit com.how_hard_can_it_be.layleadership.data.LayLeadershipSqliteRepository._entityMgrFactory
at com.how_hard_can_it_be.layleadership.data.LayLeadershipSqliteRepository._entityMgrFactory(LayLeadershipSqliteRepository.java:0)
</pre>
</div>
</div>

<div id="outline-container-orgc6a0425" class="outline-8">
<h8 id="orgc6a0425"><span class="section-number-8">10.2.5.3.3.2.3</span> <span class="done DONE">DONE</span> One final possibility: using a CDI producer method to wrap the code snippet</h8>
<div class="outline-text-8" id="text-10-2-5-3-3-2-3">
<ul class="org-ul">
<li>State "HOLD"       from "TODO"       <span class="timestamp-wrapper"><span class="timestamp">[2020-05-10 Sun 13:22] </span></span> <br />
Probably not going to do it because I'd love to keep the current conditional code so I can drop it
in an EE container later and have it Just Work.</li>
</ul>

<p>
See <a href="https://www.sitepoint.com/cdi-weld-inject-jpa-hibernate-entity-managers/">https://www.sitepoint.com/cdi-weld-inject-jpa-hibernate-entity-managers/</a>
</p>
</div>
</div>
</div>

<div id="outline-container-org1c34b71" class="outline-7">
<h7 id="org1c34b71"><span class="section-number-7">10.2.5.3.3.3</span> <span class="done DONE">DONE</span> Preventing resource leaks</h7>
<div class="outline-text-7" id="text-10-2-5-3-3-3">
<ul class="org-ul">
<li>CLOSING NOTE <span class="timestamp-wrapper"><span class="timestamp">[2020-05-10 Sun 12:52] </span></span> <br />
Calling <code>EntityManager.close()</code> at the end of a method seems to be sufficient, based on "Finer"
level logging in EclipseLink.  The Connection is returned to the pool <i>and</i> transactions seem to be
handle (unit of work is released).</li>
</ul>

<p>
Need to prevent JDBC connection leaks and other resource leaks by closing/releasing resources when appropriate
(e.g., at the end of a query?).
</p>
</div>
</div>
</div>
</div>
</div>

<div id="outline-container-org0bd882d" class="outline-4">
<h4 id="org0bd882d"><span class="section-number-4">10.2.6</span> <span class="done DONE">DONE</span> Lombok</h4>
<div class="outline-text-4" id="text-10-2-6">
<ul class="org-ul">
<li>CLOSING NOTE <span class="timestamp-wrapper"><span class="timestamp">[2020-04-13 Mon 15:18] </span></span> <br />
Actually, I gave up on this, due to complexities of annotation processing and Java 11 (i.e.,
post-Jigsaw).  Both Maven and IntelliJ IDEA are having a hard time with it.  Anyway, it bollixes up
debugging (post-compile code) and smart IDEs can just insert the stuff we need more or less
automatically.</li>
</ul>

<p>
<a href="https://projectlombok.org/">https://projectlombok.org/</a>
</p>

<p>
MvnRepository has it at <a href="https://mvnrepository.com/artifact/org.projectlombok/lombok">https://mvnrepository.com/artifact/org.projectlombok/lombok</a>.
</p>

<p>
Might be simplest to just slap a <code>@Data</code> annotation on things you expect to use it on.  (Business
objects, mostly?  I assume not DTOs, really).
</p>
</div>
</div>

<div id="outline-container-org7073deb" class="outline-4">
<h4 id="org7073deb"><span class="section-number-4">10.2.7</span> Logging &amp; Telemetry</h4>
<div class="outline-text-4" id="text-10-2-7">
</div>
<div id="outline-container-org53c7752" class="outline-5">
<h5 id="org53c7752"><span class="section-number-5">10.2.7.1</span> Responsiveness, measured from the client</h5>
</div>

<div id="outline-container-orgb5195a5" class="outline-5">
<h5 id="orgb5195a5"><span class="section-number-5">10.2.7.2</span> CDI logging</h5>
<div class="outline-text-5" id="text-10-2-7-2">
<p>
See <a href="https://weld.cdi-spec.org/documentation/#7">https://weld.cdi-spec.org/documentation/#7</a>
</p>

<p>
Add the following to $CATALINA_HOME/conf/logging.properties:
</p>

<pre class="example">
org.jboss.weld.level=FINE
</pre>
</div>
</div>

<div id="outline-container-org79eb42e" class="outline-5">
<h5 id="org79eb42e"><span class="section-number-5">10.2.7.3</span> JPA (EclipseLink) logging</h5>
<div class="outline-text-5" id="text-10-2-7-3">
<p>
See <a href="https://wiki.eclipse.org/EclipseLink/Examples/JPA/Logging">https://wiki.eclipse.org/EclipseLink/Examples/JPA/Logging</a>
</p>

<p>
Include the following in the persistence unit defined in <code>persistence.xml</code>:
</p>

<div class="org-src-container">
<pre class="src src-xml">&lt;<span style="color: #0000ff;">persistence-unit</span>&gt;
  &lt;<span style="color: #0000ff;">provider</span>&gt;org.eclipse.persistence.jpa.PersistenceProvider&lt;/<span style="color: #0000ff;">provider</span>&gt;
  &lt;<span style="color: #0000ff;">properties</span>&gt;
    <span style="color: #36648b; font-style: italic;">&lt;!-- I think you need to specify the provider if you're going to use provider-specific settings like the following. --&gt;</span>
    &lt;<span style="color: #0000ff;">property</span> <span style="color: #8b6914;">name</span>=<span style="color: #b22222;">"eclipselink.logging.level"</span> <span style="color: #8b6914;">value</span>=<span style="color: #b22222;">"FINEST"</span>/&gt;
  &lt;/<span style="color: #0000ff;">properties</span>&gt;
&lt;/<span style="color: #0000ff;">persistence-unit</span>&gt;
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org5e8fd92" class="outline-4">
<h4 id="org5e8fd92"><span class="section-number-4">10.2.8</span> Security &amp; Griefing</h4>
</div>
<div id="outline-container-org85810c9" class="outline-4">
<h4 id="org85810c9"><span class="section-number-4">10.2.9</span> Documentation generation</h4>
</div>
<div id="outline-container-orgd7cd87b" class="outline-4">
<h4 id="orgd7cd87b"><span class="section-number-4">10.2.10</span> Automated testing</h4>
<div class="outline-text-4" id="text-10-2-10">
<p>
Probably need to have the injection framework available and configured properly for unit
testing.
</p>
</div>

<div id="outline-container-org2864852" class="outline-5">
<h5 id="org2864852"><span class="section-number-5">10.2.10.1</span> Unit</h5>
</div>
<div id="outline-container-org54a5966" class="outline-5">
<h5 id="org54a5966"><span class="section-number-5">10.2.10.2</span> Integration</h5>
</div>
<div id="outline-container-orgf5129d8" class="outline-5">
<h5 id="orgf5129d8"><span class="section-number-5">10.2.10.3</span> Database?</h5>
</div>
</div>
<div id="outline-container-org8acba66" class="outline-4">
<h4 id="org8acba66"><span class="section-number-4">10.2.11</span> Code coverage during [automated] testing</h4>
</div>
<div id="outline-container-org64206f4" class="outline-4">
<h4 id="org64206f4"><span class="section-number-4">10.2.12</span> Command pattern, undo/redo trees</h4>
</div>
<div id="outline-container-org8fa05f0" class="outline-4">
<h4 id="org8fa05f0"><span class="section-number-4">10.2.13</span> Well-known APIs</h4>
<div class="outline-text-4" id="text-10-2-13">
</div>
<div id="outline-container-org7498ad9" class="outline-5">
<h5 id="org7498ad9"><span class="section-number-5">10.2.13.1</span> Documenting with something like Swagger</h5>
</div>
</div>
<div id="outline-container-org52eaab2" class="outline-4">
<h4 id="org52eaab2"><span class="section-number-4">10.2.14</span> Data export/import</h4>
</div>
<div id="outline-container-org32216e4" class="outline-4">
<h4 id="org32216e4"><span class="section-number-4">10.2.15</span> Stress testing, esp. for database</h4>
<div class="outline-text-4" id="text-10-2-15">
<p>
Want to test multiple, concurrent writes.
</p>

<p>
Want to test concurrency in general.
</p>
</div>
</div>

<div id="outline-container-org66050b9" class="outline-4">
<h4 id="org66050b9"><span class="section-number-4">10.2.16</span> SQL profiling, tracing</h4>
<div class="outline-text-4" id="text-10-2-16">
<p>
Want to see what kinds of queries are actually created by whatever ORM system/framework I
choose.
</p>
</div>
</div>

<div id="outline-container-org0576a03" class="outline-4">
<h4 id="org0576a03"><span class="section-number-4">10.2.17</span> <span class="todo IN_PROGRESS">IN-PROGRESS</span> Object mappers (Domain/DTO)</h4>
<div class="outline-text-4" id="text-10-2-17">
<p>
Would be nice to be able to automagically transform DTOs to Domain objects and vice versa.
</p>

<p>
Consider:
</p>

<ul class="org-ul">
<li>MapStruct (<a href="https://mapstruct.org/">https://mapstruct.org/</a>)</li>
<li>modelmapper (<a href="http://modelmapper.org/">http://modelmapper.org/</a>)</li>
<li>JMapper (<a href="https://jmapper-framework.github.io/jmapper-core/">https://jmapper-framework.github.io/jmapper-core/</a>)</li>
</ul>

<p>
See also:
</p>

<ul class="org-ul">
<li><a href="https://www.baeldung.com/entity-to-and-from-dto-for-a-java-spring-application">https://www.baeldung.com/entity-to-and-from-dto-for-a-java-spring-application</a></li>
<li><a href="https://www.baeldung.com/java-performance-mapping-frameworks">https://www.baeldung.com/java-performance-mapping-frameworks</a></li>
<li><a href="https://www.reddit.com/r/java/comments/dt86ul/best_object_mapping_frameworks_for_java/?utm_medium=android_app&amp;utm_source=share">https://www.reddit.com/r/java/comments/dt86ul/best_object_mapping_frameworks_for_java/?utm_medium=android_app&amp;utm_source=share</a></li>
</ul>
</div>

<div id="outline-container-orgad92545" class="outline-5">
<h5 id="orgad92545"><span class="section-number-5">10.2.17.1</span> <span class="todo HOLD">HOLD</span> JMapper</h5>
<div class="outline-text-5" id="text-10-2-17-1">
<ul class="org-ul">
<li><p>
State "HOLD"       from "IN-PROGRESS" <span class="timestamp-wrapper"><span class="timestamp">[2020-05-12 Tue 09:40] </span></span> <br />
Maybe I won't use this, in lieu of Mapstruct.  Recent Reddit post (6 months old!) seems to prefer Mapstruct, sort of;
and I'm finding the JMapper docs pretty awful.  Gonna go research Mapstruct now.
</p>

<p>
One good thing I learned from my foray into JMapper is how easy it is to load a resource from a jar file, something I
had forgotten.
</p></li>
</ul>

<p>
Don't want to annotate business-class objects with JMapper annotations because that introduces a dependency on
JMapper in the business class, which we don't want to do (<a href="#maven-project-structure">onion core</a> (<a href="#org923d847">1</a>), no dependencies, pls).
</p>

<p>
So, we're trying an XML mapper.
</p>

<p>
Turns out the classpath for a JAR file is&#x2026; the root of the JAR, duh.  So, we can put the xml mapping (named
whatever we want) into <code>src/main/resources/META-INF</code> for the Data module, which puts it in <code>/META-INF</code> in the root
of the jar, and we can pull it right back at run time via path <code>"META-INF/jmapper.xml"</code> (or whatever we named it).
</p>

<p>
See <a href="https://stackoverflow.com/a/4585668">https://stackoverflow.com/a/4585668</a>.
</p>
</div>
</div>

<div id="outline-container-orgd69b8bb" class="outline-5">
<h5 id="orgd69b8bb"><span class="section-number-5">10.2.17.2</span> <span class="todo IN_PROGRESS">IN-PROGRESS</span> Mapstruct</h5>
<div class="outline-text-5" id="text-10-2-17-2">
<p>
Looks like there are two pieces you need: mapstruct-core and mapstruct-processor.
</p>

<p>
Core is, I guess, the runtime part you need, and Processor is the compile-time part you need, <i>as a compiler
plugin</i> (so I guess it doesn't stick around after that phase).
</p>

<p>
From the docs:
</p>

<blockquote>
<p>
The general philosophy of MapStruct is to generate code which looks as much as possible as if you had written it
yourself from hand. In particular this means that the values are copied from source to target by plain
getter/setter invocations instead of reflection or similar.
</p>
</blockquote>
</div>

<div id="outline-container-org4c7f15f" class="outline-6">
<h6 id="org4c7f15f"><span class="section-number-6">10.2.17.2.1</span> <span class="todo RESEARCH_TODO">RESEARCH-TODO</span> Using Builders</h6>
<div class="outline-text-6" id="text-10-2-17-2-1">
<p>
Oh, nice:  MapStruct can use a builder to create an immutable object.  So, since it doesn't use reflection to
update read-only private fields (I always feel that's a bit sketchy), I can write a builder (or can that be
automatically generated, somehow?).  I guess the key is that, once an object is built, calling a setter (or some
setters) should result in an error.
</p>

<p>
(Hmm, the phrasing on the "multiple build methods" bullet item is terrible &#x2013; maybe this can be my first ever pull
request.)
</p>

<p>
Note that IntelliJ can create a builder for a constructor for an immutable object, and even update it (supposedly)
if you add new properties to the object.  This is some IDE magic I can live with.
</p>

<p>
If IntelliJ's builder supports the default <code>BuilderProvider</code>, we're golden.
</p>

<p>
Some info on specific builders that work with MapStruct:
<a href="https://mapstruct.org/documentation/stable/reference/html/#mapping-with-builders">https://mapstruct.org/documentation/stable/reference/html/#mapping-with-builders</a>
</p>

<p>
It looks like we can use the builders created by Intellij with two changes:
</p>

<ol class="org-ol">
<li>Change the generated <code>createFoo()</code> method that creates a <code>Foo</code> to just <code>create()</code> (note that this basically
breaks IntelliJ's "update builder" refactoring, since it loses track of the <code>create()</code> method); and</li>
<li>Add a static public getter to the target class that's being built to return the builder (TODO: hmm, how
threadsafe is this?)</li>
</ol>
</div>
</div>
</div>

<div id="outline-container-org1811eac" class="outline-5">
<h5 id="org1811eac"><span class="section-number-5">10.2.17.3</span> <span class="done DONE">DONE</span> Is this required when using JPQL?</h5>
<div class="outline-text-5" id="text-10-2-17-3">
<ul class="org-ul">
<li>CLOSING NOTE <span class="timestamp-wrapper"><span class="timestamp">[2020-05-10 Sun 13:35] </span></span> <br />
Yes, I think it is.  The JPA stuff just gets us DTO, not full-blown business objects.</li>
</ul>
</div>
</div>

<div id="outline-container-org160598f" class="outline-5">
<h5 id="org160598f"><span class="section-number-5">10.2.17.4</span> <span class="done DONE">DONE</span> Is this required when using Criteria?</h5>
<div class="outline-text-5" id="text-10-2-17-4">
<ul class="org-ul">
<li>CLOSING NOTE <span class="timestamp-wrapper"><span class="timestamp">[2020-05-10 Sun 13:36] </span></span> <br />
Yes, I think it is.  The JPA stuff just gets us DTO, not full-blown business objects.</li>
</ul>
</div>
</div>
</div>
</div>
</div>

<div id="outline-container-org8bebbb9" class="outline-2">
<h2 id="org8bebbb9"><span class="section-number-2">11</span> Operations</h2>
<div class="outline-text-2" id="text-11">
<p>
Once the code is written&#x2026;.
</p>
</div>

<div id="outline-container-org65963e8" class="outline-3">
<h3 id="org65963e8"><span class="section-number-3">11.1</span> Deploying</h3>
<div class="outline-text-3" id="text-11-1">
<p>
Deploying a web app via the Tomcat "manager" UI results in the first line in the log file
(<code>catalina.out</code>) looking like this:
</p>

<pre class="example">
17-Apr-2020 18:21:39.602 INFO [http-nio-8080-exec-53] org.apache.catalina.startup.HostConfig.deployWAR Deploying web application archive [/opt/apache-tomcat-9.0.31/webapps/Web.war]
</pre>
</div>

<div id="outline-container-org95667f5" class="outline-4">
<h4 id="org95667f5"><span class="section-number-4">11.1.1</span> Deploying as part of build (via Maven)</h4>
<div class="outline-text-4" id="text-11-1-1">
<p>
(Deploying to test server, obviously.)
</p>
</div>
</div>
</div>

<div id="outline-container-orgd88863c" class="outline-3">
<h3 id="orgd88863c"><span class="section-number-3">11.2</span> Diagnosing Deploy-Time Errors</h3>
<div class="outline-text-3" id="text-11-2">
</div>
<div id="outline-container-org0fe80c1" class="outline-4">
<h4 id="org0fe80c1"><span class="section-number-4">11.2.1</span> Injection failures</h4>
<div class="outline-text-4" id="text-11-2-1">
</div>
<div id="outline-container-org384a36d" class="outline-5">
<h5 id="org384a36d"><span class="section-number-5">11.2.1.1</span> <span class="done DONE">DONE</span> Unsatisfied dependencies</h5>
<div class="outline-text-5" id="text-11-2-1-1">
<ul class="org-ul">
<li>CLOSING NOTE <span class="timestamp-wrapper"><span class="timestamp">[2020-05-04 Mon 11:27] </span></span> <br />
Figured out that runtime dependencies need to be declared in Maven POM.</li>
<li>CLOSING NOTE <span class="timestamp-wrapper"><span class="timestamp">[2020-04-25 Sat 12:37] </span></span> <br />
Annotate the beans properly, and you're good.</li>
</ul>

<pre class="example">
Unsatisfied dependencies for type LayLeadershipRepository with qualifiers @Default
  at injection point [BackedAnnotatedField] @Inject private com.how_hard_can_it_be.layleadership.servlet.MembersServlet._layLeadershipRepository
  at com.how_hard_can_it_be.layleadership.servlet.MembersServlet._layLeadershipRepository(MembersServlet.java:0)
</pre>

<p>
<i>Apparently</i> the interface and the implementation must be in the same JAR file.  (Really? Do we
really believe that? No, right? Because then how could you have a third-party bean satisfy an
interface and be injected?).
</p>

<p>
Answer: no, they don't have to be in the same JAR/module.  But, apparently, you <i>do</i> have to
annotate the beans you expect this to work for, so the CDI container knows that they <i>are</i>
beans to be managed.
</p>
</div>

<div id="outline-container-org78cab2a" class="outline-6">
<h6 id="org78cab2a"><span class="section-number-6">11.2.1.1.1</span> Further notes on dependencies and required build (POM) structuring</h6>
<div class="outline-text-6" id="text-11-2-1-1-1">
<p>
BUT&#x2026; you must have sufficient module (jar) dependency declarations to ensure that the module
(jar) implementing your CDI bean interface actually gets included in the build output.  It's
not enough to satisfy the compiler.  More specifically:
</p>

<p>
Interface was declared in <code>Svc</code> ("service") module, so servlet code (or whatever is the client of <code>Svc</code>) could
depend on only that interface (and module).
</p>

<p>
Implementation was defined in <code>Data</code> module, which I intended to have sort of hidden away,
since <code>Svc</code> clients didn't need to know about it directly.
</p>

<p>
<code>Data</code> depends on <code>Svc</code>, because <code>Data</code> refers to the interface in <code>Svc</code>.  (Can I compile w/out
the dependency declared in <code>Data</code>?  Answer: no.  Compilation fails w/out the required
dependencies declared in the POMs.)
</p>

<p>
However, <code>Web</code>, the module with servlets and JSPs, only needs to depend <i>at compile-time</i> on
<code>Svc</code>, since <code>Web</code> really only knows about the interfaces declared in <code>Svc</code>, and not the
implementations defined in <code>Data</code>.  That's sort of the whole point of dependency injection.
</p>

<p>
Unfortunately, if you satisfy yourself with just those dependencies, diagrammed below, then the result of the
Maven build will not include the <code>Data</code> jar file.
</p>

<div class="org-src-container">
<pre class="src src-plantuml"><span style="color: #a020f0;">@startuml</span>
<span style="color: #228b22;">component</span> Web
<span style="color: #228b22;">component</span> Svc
<span style="color: #228b22;">component</span> Data

Web <span style="color: #a020f0;">--&gt;</span> Svc
Data <span style="color: #a020f0;">--&gt;</span> Svc
<span style="color: #a020f0;">@enduml</span>
</pre>
</div>


<div class="figure">
<p><img src="cdi-dependencies-to-satisfy-compiler.png" alt="cdi-dependencies-to-satisfy-compiler.png" />
</p>
</div>

<p>
You might, if you have real sharp eyes, notice that Maven builds the <code>Web</code> module <i>before</i> it
builds the <code>Data</code> module, which should give you a hint that the <code>Web</code> module won't include the
<code>Data</code> jar.
</p>

<p>
You can also be misled because Maven packaging can sweep up the results of old builds, which
might have some old jar files lying around.  To prevent that from happening, <b>run a "clean"
operation if you change module dependencies</b>.
</p>

<p>
Instead, you need to add an extra dependency in the <code>Web</code> module to explicitly declare that it
has a (run-time) dependency on <code>Data</code>.  This is because the compiler doesn't need the
reference, but the dependency-injection system <i>does</i> need it.  Otherwise, the runtime
dependency can't be resolved, and you get more nasty errors about "unable to resolve
dependency":
</p>

<pre class="example">
Caused by: org.jboss.weld.exceptions.DeploymentException: WELD-001408: Unsatisfied dependencies for type LayLeadershipRepository with qualifiers @Default
at injection point [BackedAnnotatedField] @Inject private com.how_hard_can_it_be.layleadership.servlet.MembersServlet._layLeadershipRepository
at com.how_hard_can_it_be.layleadership.servlet.MembersServlet._layLeadershipRepository(MembersServlet.java:0)
</pre>

<p>
So, the dependencies you need to declare in Maven are as follows:
</p>

<div class="org-src-container">
<pre class="src src-plantuml"><span style="color: #a020f0;">@startuml</span>
<span style="color: #228b22;">component</span> Web
<span style="color: #228b22;">component</span> Svc
<span style="color: #228b22;">component</span> Data

Web <span style="color: #a020f0;">--&gt;</span> Svc
Data <span style="color: #a020f0;">--&gt;</span> Svc
Web <span style="color: #a020f0;">--&gt;</span> Data                    <span style="color: #36648b; font-style: italic;">/' </span><span style="color: #36648b; font-style: italic;">This is new. </span><span style="color: #36648b; font-style: italic;">'/</span>
<span style="color: #a020f0;">@enduml</span>
</pre>
</div>


<div class="figure">
<p><img src="cdi-dependencies-to-satisfy-runtime.png" alt="cdi-dependencies-to-satisfy-runtime.png" />
</p>
</div>
</div>
</div>
</div>

<div id="outline-container-org0db2a7d" class="outline-5">
<h5 id="org0db2a7d"><span class="section-number-5">11.2.1.2</span> <span class="done DONE">DONE</span> Ambiguous dependencies</h5>
<div class="outline-text-5" id="text-11-2-1-2">
<pre class="example">
      Caused by: org.jboss.weld.exceptions.DeploymentException: WELD-001409: Ambiguous dependencies for type LayLeadershipRepository with qualifiers @Default
at injection point [BackedAnnotatedField] @Inject private com.how_hard_can_it_be.layleadership.servlet.MembersServlet._layLeadershipRepository
at com.how_hard_can_it_be.layleadership.servlet.MembersServlet._layLeadershipRepository(MembersServlet.java:0)
Possible dependencies: 
- Managed Bean [class com.how_hard_can_it_be.layleadership.data.LayLeadershipSqliteRepository] with qualifiers [@Any @Default],
- Managed Bean [class com.how_hard_can_it_be.layleadership.data.LayLeadershipRepositoryScaffold] with qualifiers [@Any @Default]
</pre>

<p>
I believe the problem here is that both injectable beans are defaulting to qualifiers <code>@Any</code>
and <code>@Default</code> because we haven't given them any other qualifiers.
</p>

<p>
The fix is to declare a <code>Mock</code> qualifier annotation and use it to annotate the "scaffold"
version so it no longer has the default <code>@Default</code> qualifier.
</p>

<div class="org-src-container">
<pre class="src src-java"><span style="color: #008b8b;">@Qualifier</span>
<span style="color: #008b8b;">@Retention</span>( <span style="color: #228b22;">RUNTIME</span> )
<span style="color: #008b8b;">@Target</span>( {TYPE, <span style="color: #228b22;">FIELD</span>, <span style="color: #228b22;">METHOD</span>, PARAMETER} )
<span style="color: #a020f0;">public</span> <span style="color: #a020f0;">@interface</span> <span style="color: #228b22;">Mock</span> {}
</pre>
</div>
</div>

<div id="outline-container-org14623bb" class="outline-6">
<h6 id="org14623bb"><span class="section-number-6">11.2.1.2.1</span> On annotations</h6>
<div class="outline-text-6" id="text-11-2-1-2-1">
<p>
For those coming to this a bit raw, <i>annotations</i> are Java's way of attaching extra
meta-information to various elements of Java code during the compile phase.  Reflection is
used to act on these annotations.
</p>

<p>
This particular definition breaks down as follows:
</p>

<p>
<code>@interface</code> is how you declare an annotation.  It's basically the <code>interface</code> keyword you're
used to, plus an extra <code>@</code> preceding it.  An annotation <i>is</i> a kind of interface.
</p>

<p>
This annotation declaration is itself annotated with more annotations.
</p>

<p>
<code>@Retention</code> specifies how long the compiler is to retain this new piece of meta-information.
<code>RUNTIME</code> means this information is to be available at runtime, to the JVM, so basically:
forever.  Some other types of info are thrown away earlier and don't make it out to the final
byte-code.
</p>

<p>
<code>@Target</code> specifies which kinds of code elements are legal places for this new annotation.
We've specified classes (types), data members (fields), methods and parameters, which is kind
of everything normal.
</p>

<p>
And, finally, we sucked in the annotation <code>javax.inject.Qualifier</code>, which basically specifies
that this new annotation (<code>Mock</code>) is an injection <i>qualifier</i>.  When we use <code>Mock</code> to annotate
a class (our d/b "scaffold" implmentation), that means the class won't (by default) have the
<code>@Default</code> annotation, which should clear up our ambiguity (since now only <i>one</i> class will
have the <code>@Default</code> qualifier).
</p>

<p>
The way we use this is, when we write our unit tests and we want to mock the d/b, we specify
an injection point in our unit test qualified with <code>@Mock</code>, so the injection container will
then inject our mock repository that doesn't actually hit the database.
</p>
</div>
</div>
</div>
</div>

<div id="outline-container-orgf15a637" class="outline-4">
<h4 id="orgf15a637"><span class="section-number-4">11.2.2</span> <span class="done DONE">DONE</span> D/B connection problems (JNDI problem)</h4>
<div class="outline-text-4" id="text-11-2-2">
<ul class="org-ul">
<li>CLOSING NOTE <span class="timestamp-wrapper"><span class="timestamp">[2020-04-21 Tue 22:16] </span></span> <br />
Fixed.  See <a href="web-app-journal.html#web-xml-structure"><code>web.xml</code> structure</a>.</li>
</ul>

<pre class="example">
java.sql.SQLException: Cannot create JDBC driver of class '' for connect URL 'null'
</pre>


<p>
So, apparently, the JNDI lookup defined in <a href="#tomcat-jndi-resources">JDBC connection</a> (GlobalNamingResources) isn't
returning a sqlite object.
</p>
</div>

<div id="outline-container-org653f7eb" class="outline-5">
<h5 id="org653f7eb"><span class="section-number-5">11.2.2.1</span> <span class="done DONE">DONE</span> Direct JDBC connection</h5>
<div class="outline-text-5" id="text-11-2-2-1">
<p>
Let's see if we've even got sqlite set up correctly.  We'll modify the injected bean to
directly connect to the d/b.
</p>

<p>
putting
</p>

<pre class="example">
conn = DriverManager.getConnection( "jdbc:sqlite:/usr/local/var/LayLeadership/tasks.db");
</pre>


<p>
in <code>LayLeadershipSqliteRepository.getAllMembers()</code> results in:
</p>

<pre class="example">
No suitable driver found for jdbc:sqlite:/usr/local/var/LayLeadership/tasks.db
</pre>


<p>
So&#x2026; progress?
</p>

<p>
Debugging and dumping out the result of <code>System.getProperties()</code> (expression evaluation window)
gives:
</p>

<dl class="org-dl">
<dt>java.class.path</dt><dd>"/opt/apache-tomcat-9.0.31/bin/bootstrap.jar:/opt/apache-tomcat-9.0.31/bin/tomcat-juli.jar"</dd>
</dl>

<p>
Well, that's unhelpful.  Probably Tomcat has a separate classloader for each app, and this
system property is meaningless.
</p>

<p>
So&#x2026; it turns out this works if you do a couple of things just right:
</p>

<ol class="org-ol">
<li>Get the url right.  Be sure you're referring to a d/b file that exists, and the "tomcat"
user has read/write permission to it.  (At some point, I switched from <code>tasks.db</code> to
<code>layleadership.db</code>.)</li>

<li>Explicitly load the class in code with a call to <code>Class.forName( "org.sqlite.JDBC" )</code>.</li>

<li>Iterate through the drivers obtained via <code>DriverManager.getDrivers()</code>, asking each driver if
it can accept the url.</li>
</ol>

<p>
This doesn't seem right; Tomcat should be handling all this for us.  I suspect I've still got
something misconfigured, but at least we can access the database <i>somehow</i>.
</p>
</div>
</div>

<div id="outline-container-orgbfeab1a" class="outline-5">
<h5 id="web-xml-structure"><span class="section-number-5">11.2.2.2</span> <span class="done RESEARCH_DONE">RESEARCH-DONE</span> <code>web.xml</code> structure</h5>
<div class="outline-text-5" id="text-web-xml-structure">
<ul class="org-ul">
<li>CLOSING NOTE <span class="timestamp-wrapper"><span class="timestamp">[2020-04-22 Wed 21:50] </span></span> <br />
Don't use <code>copyXML</code>.  Instead&#x2026;.</li>
<li>CLOSING NOTE <span class="timestamp-wrapper"><span class="timestamp">[2020-04-19 Sun 21:45] </span></span> <br />
This way lies madness.  Turn back, O mortal.</li>
</ul>

<p>
[head exploded after reading both the spec and the various <code>.xsd</code> files involved.]
</p>

<p>
Might be best to move the <code>server.xml</code> part out of the global naming whatsis and into
<code>context.xml</code> in the deployed files (<code>.war</code>).  Tomcat allows this file to be "externalized", by
placing it in the <code>conf</code> hierarchy, which allows it to be preserved between deploys (although
TODO: find out if the <code>copyXML</code> attribute of the host will overwrite this file; reading the
docs leaves the answer unclear (it's ok for "start" but what about "deploy".  Will deploying a
new version of the WAR file result in the copied <code>context.xml</code> being overwritten?).
</p>

<p>
Answer: it overwrites the older, extracted version.  So, I guess the answer is: don't use
copyXML.  Instead, copy <code>context.xml</code> to <code>conf/&lt;engine&gt;/&lt;host&gt;/&lt;context&gt;.xml</code> and edit (once) as
needed.
</p>

<p>
Where <code>&lt;engine&gt;</code> is probably <code>Cataline</code> and <code>&lt;host&gt;</code> may be <code>localhost</code> and <code>&lt;context&gt;</code> is the
context path of the application (which may corresponds to the name of the WAR file used to
deploy it).
</p>
</div>
</div>
</div>
</div>

<div id="outline-container-orgb45a659" class="outline-3">
<h3 id="orgb45a659"><span class="section-number-3">11.3</span> <span class="done DONE">DONE</span> Debugging</h3>
<div class="outline-text-3" id="text-11-3">
<p>
Now you've got it deployed and it's messing up, so you need to debug.
</p>

<p>
Need to start Tomcat with these arguments (which I found when I tried to configure remote
debuging in IntelliJ IDEA; different IDEs might have different requirements):
</p>

<pre class="example">
-agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=*:5005
</pre>


<p>
If you look at the <code>catalina.sh</code> scripts that comes with Tomcat, you'll see a section that
processes an argument of "jpda" by using environment variables like <code>JPDA_ADDRESS</code>.  In my case,
the only one that was different by default from the arguments given above was the address.  It's
probably better to use <code>localhost</code> instead of <code>*</code>, due to the need to either escape the <code>*</code> or
use quotes (which the script says won't work).  Override (in a separate
environment-variable-setting script) the variables you need to override and you should be good to
go, with a command-line invocation like <code>catalina.sh jpda start</code>.
</p>

<p>
A little vocabulary:
</p>

<dl class="org-dl">
<dt>JDWP</dt><dd>Java Debug Wire Protocol</dd>
<dt>JPDA</dt><dd>Java Platform Debugger Architecture</dd>
</dl>

<hr />
</div>
</div>
</div>
<div id="footnotes">
<h2 class="footnotes">Footnotes: </h2>
<div id="text-footnotes">

<div class="footdef"><sup><a id="fn.1" class="footnum" href="#fnr.1">1</a></sup> <div class="footpara"><p class="footpara">
I'd be happy to find an exception to this, but&#x2026; in my experience, most developers in the Microsoft world seem
to have the attitude that if something
isn't created by Microsoft or endorsed by them, it's not worth their attention.  So, that whole
open-source world mostly just leaves them cold.  I know things have changed recently and MS has
Turned Over a Whole New Leaf, but the attitudes of the zillions of developers haven't really
changed, and there's still, even now, a ton of baggage.  Even now, open source is only cool because
Microsoft has endorsed it.  <br />
<br />
The Microsoft world is still dealing with old Microsoft decisions from decades ago, and the result is
still a bit hacky (mixed-mode compilations, anyone? interop libraries?). <br />
<br />
<b>Also&#x2026;</b> the Java world seems to proceed mostly from specification to implementation (with really
good javadocs<sup><a id="fnr.2" class="footref" href="#fn.2">2</a></sup>), while the Microsoft world is more "whatever Microsoft implemented, that's the
standard, and we just have to hope they documented it well and why would anybody else re-implement
it?".  I just see the Java world as cleaner, really.
</p></div></div>

<div class="footdef"><sup><a id="fn.2" class="footnum" href="#fnr.2">2</a></sup> <div class="footpara"><p class="footpara">
Well, <i>mostly</i>.
</p></div></div>

<div class="footdef"><sup><a id="fn.3" class="footnum" href="#fnr.3">3</a></sup> <div class="footpara"><p class="footpara">
I understand some folks like the idea of Mono on Linux, but that just seems like buying trouble.
</p></div></div>


</div>
</div></div>
<div id="postamble" class="status">
<p class="date">Created: 2020-05-12 Tue 17:48</p>
<p class="creator"><a href="https://www.gnu.org/software/emacs/">Emacs</a> 26.2 (<a href="https://orgmode.org">Org</a> mode 9.3.6)</p>
<p class="validation"><a href="http://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
